
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Configuration Guide Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="developer.html" />
    
    
    <link rel="prev" href="admin.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="user.html">
            
                <a href="user.html">
            
                    
                    User Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="admin.html">
            
                <a href="admin.html">
            
                    
                    Deployment And Administration Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="config.html">
            
                <a href="config.html">
            
                    
                    Configuration Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="developer.html">
            
                <a href="developer.html">
            
                    
                    Developer Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="rsp.html">
            
                <a href="rsp.html">
            
                    
                    Relying Service Provider (RSP) Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="api.html">
            
                <a href="api.html">
            
                    
                    REST Api
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="service_ref_card.html">
            
                <a href="service_ref_card.html">
            
                    
                    WaTTS - Service Reference Card
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Configuration Guide</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="configuration-guide">Configuration Guide</h1>
<p>The configuration of WaTTS consists of one file. The file is located at <code>/etc/watts/watts.conf</code>.
One other location is supported for development purposes; in this case please place your
configuration file as <code>~/.config/watts/watts.conf</code>.</p>
<h2 id="configuration-wattsconf">Configuration (watts.conf)</h2>
<p>The WaTTS is deployed with sane defaults, you only need to touch user-specific
changes.</p>
<p>Each setting consists of one simple line of the format, comments are starting with &apos;#&apos;.</p>
<pre><code># this is a comment and ignored
key = value
</code></pre><h3 id="testing-your-configuration">Testing your configuration</h3>
<p>WaTTS provides a simple command to check the configuration file</p>
<pre><code>watts chkconfig
</code></pre><p>run it after changing the configuration to ensure your configuration file is correct.
If everything is fine it will print out a line telling you so:</p>
<pre><code>config is OK
</code></pre><h3 id="datatypes">Datatypes</h3>
<p>There are different datatypes used in the configuration, a detailed description can be
seen in the following table.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Datatype</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">&apos;word&apos;</td>
<td>the word itself is the value, without the &apos;</td>
</tr>
<tr>
<td style="text-align:center">host</td>
<td>a valid fully qualified hostname</td>
</tr>
<tr>
<td style="text-align:center">port</td>
<td>an integer within the valid range for TCP ports</td>
</tr>
<tr>
<td style="text-align:center">boolean</td>
<td>either &apos;true&apos; or &apos;false&apos;</td>
</tr>
<tr>
<td style="text-align:center">file</td>
<td>an absolute path to a file</td>
</tr>
<tr>
<td style="text-align:center">dir</td>
<td>an absolute path to a directory</td>
</tr>
<tr>
<td style="text-align:center">duration</td>
<td>a timespan given by an integer and a unit, the unit can be ms, s, m, h</td>
</tr>
<tr>
<td style="text-align:center">string</td>
<td>just the string value</td>
</tr>
<tr>
<td style="text-align:center">integer</td>
<td>an integer value, i.e. a number</td>
</tr>
<tr>
<td style="text-align:center">url</td>
<td>a valid url, use https as much as possible</td>
</tr>
<tr>
<td style="text-align:center">comma separated list</td>
<td>values separated by comma</td>
</tr>
<tr>
<td style="text-align:center">any</td>
<td>depends on the usage and can&apos;t be specified</td>
</tr>
</tbody>
</table>
<h3 id="watts-server-settings">WaTTS server settings</h3>
<h4 id="introduction">Introduction</h4>
<p>This section will describe the general settings of the WaTTS server. This will include options like
ports, hostname and SSL.</p>
<p>Typical values that should be changed during the initial setup are:</p>
<ul>
<li><code>hostname</code>, change it to an actual fully qualified hostname</li>
<li><code>port</code>, which can be removed if the incoming traffic arrives at port <em>80</em> for <em>http</em> or <em>443</em> for <em>https</em></li>
<li><code>listen_port</code>, it will be set to the internal port WaTTS is listening at</li>
</ul>
<p>And for production use:</p>
<ul>
<li><code>ssl</code>, set to &apos;true&apos;</li>
<li><code>cachain_file</code>, set to the path to the file</li>
<li><code>dh_file</code>, set to the path to the file</li>
<li><code>cert_file</code>, set to the path to the file</li>
<li><code>key_file</code>, set to the path to the file</li>
</ul>
<h4 id="settings">Settings</h4>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th>Description</th>
<th style="text-align:center">Datatype</th>
<th style="text-align:center">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">nodename</td>
<td>The name of the Erlang distrubuted node. Do not change unless really needed.</td>
<td style="text-align:center">string</td>
<td style="text-align:center">watts@127.0.0.1</td>
</tr>
<tr>
<td style="text-align:center">distributed_cookie</td>
<td>The cookie of the Erlang distrubution. Do not change unless really needed.</td>
<td style="text-align:center">string</td>
<td style="text-align:center">watts</td>
</tr>
<tr>
<td style="text-align:center">hostname</td>
<td>Hostname of the web server</td>
<td style="text-align:center">host</td>
<td style="text-align:center">localhost</td>
</tr>
<tr>
<td style="text-align:center">port</td>
<td>Port number where clients seem to connect to; default is port 80 for non SSL, 443 for SSL. In production systems this should be left &apos;default&apos;</td>
<td style="text-align:center">port number or &apos;default&apos;</td>
<td style="text-align:center">8080</td>
</tr>
<tr>
<td style="text-align:center">listen_port</td>
<td>Port at which WaTTS actually listens, used to support listening at non-privileged ports; the traffic must then be redirected from the privileged ports to the listen_port usually by the firewall. The value &apos;port&apos; means using the same value as <code>port</code></td>
<td style="text-align:center">port or &apos;port&apos;</td>
<td style="text-align:center">&apos;port&apos;</td>
</tr>
<tr>
<td style="text-align:center">ssl</td>
<td>Whether SSL should be used</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">cachain_file</td>
<td>Location of the ca chain for the server</td>
<td style="text-align:center">file</td>
<td style="text-align:center">none</td>
</tr>
<tr>
<td style="text-align:center">cert_file</td>
<td>Location of the certificate</td>
<td style="text-align:center">file</td>
<td style="text-align:center">/etc/watts/watts.crt</td>
</tr>
<tr>
<td style="text-align:center">key_file</td>
<td>Path to the private key file</td>
<td style="text-align:center">file</td>
<td style="text-align:center">/etc/watts/watts.key</td>
</tr>
<tr>
<td style="text-align:center">dh_file</td>
<td>Path to the file containing the diffie hellman parameter. To generate it simply run <code>openssl dhparam -out watts_dh.pem 2048</code></td>
<td style="text-align:center">file</td>
<td style="text-align:center">none</td>
</tr>
<tr>
<td style="text-align:center">session_timeout</td>
<td>The duration for which a session at the web-app is valid during inactivity</td>
<td style="text-align:center">duration</td>
<td style="text-align:center">15m</td>
</tr>
<tr>
<td style="text-align:center">session_max_duration</td>
<td>The maximum duration of a session at the web interface, even if active. After this time an additional Login is required</td>
<td style="text-align:center">duration</td>
<td style="text-align:center">30m</td>
</tr>
<tr>
<td style="text-align:center">database_type</td>
<td>The type of database to user</td>
<td style="text-align:center">&apos;sqlite&apos;, &apos;mnesia&apos;</td>
<td style="text-align:center">&apos;sqlite&apos;</td>
</tr>
<tr>
<td style="text-align:center">sqlite_file</td>
<td>Path to the sqlite database, used if database_type is &apos;sqlite&apos;</td>
<td style="text-align:center">file</td>
<td style="text-align:center">/etc/watts/watts.db</td>
</tr>
<tr>
<td style="text-align:center">mnesia_dir</td>
<td>Base directory of the mnesia database, used if database_type is &apos;mnesia&apos;</td>
<td style="text-align:center">dir</td>
<td style="text-align:center">/etc/watts/mnesia</td>
</tr>
<tr>
<td style="text-align:center">redirection.enable</td>
<td>Whether redirection should be enabled</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">redirection.listen_port</td>
<td>The port to listen on for browsers to redirect</td>
<td style="text-align:center">port</td>
<td style="text-align:center">8080</td>
</tr>
<tr>
<td style="text-align:center">allow_dropping_credentials</td>
<td>Whether credentials of unknown services can be silently dropped</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">enable_docs</td>
<td>Whether the documentation is reachable at /docs/</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">max_provider_wait</td>
<td>The duration to wait for provider results. If the duration is passed the results of OpenID Connect provider won&apos;t be logged, the provider will still function.</td>
<td style="text-align:center">duration</td>
<td style="text-align:center">30s</td>
</tr>
<tr>
<td style="text-align:center">log_dir</td>
<td>The path where the log files will be put</td>
<td style="text-align:center">path</td>
<td style="text-align:center">/var/log/watts</td>
</tr>
<tr>
<td style="text-align:center">syslog_facility</td>
<td>The facility to use for syslog</td>
<td style="text-align:center">&apos;daemon&apos;,&apos;local0&apos;-&apos;local7&apos;</td>
<td style="text-align:center">&apos;daemon&apos;</td>
</tr>
<tr>
<td style="text-align:center">enable_rsp</td>
<td>Enable support for RSP (relying service provider) at WaTTS. This will enable support for other services to rely on WaTTS to perform certain taks e.g. run plugins for them.</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">debug_mode</td>
<td>enable debug output, this adds a lot of load. debug_mode is only allowed when running on localhost as it might log senstive data.</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">false</td>
</tr>
</tbody>
</table>
<h4 id="listenport-redirection-explained">Listen_Port, Redirection Explained</h4>
<p>The idea is to run WaTTS as a dedicated <em>non root</em> user for security reasons.
The drawback of not beeing root is that ports 1-1024 are not available to WaTTS.
To still be able to have WaTTS running at port 80 or 443 several settings are needed.</p>
<p>As an image tells more than a thousand words, soma ascii art:</p>
<pre><code>client --[port]---&gt; firewall rules --[listen_port]--&gt; WaTTS
</code></pre><p>In the picture above the client connects to the port <code>port</code> and firewall rules
redirect the packages arriving at <code>port</code> to the <code>listen_port</code> at which WaTTS is actually listen.
The corresponding firewall rule is:</p>
<pre><code>iptables -t nat -A PREROUTING -i eth0 -p tcp --dport `port` -j REDIRECT --to-port `listen_port`
</code></pre><p>Redirection is needed when using SSL and http traffic should be forwarded to the https endpoint.
The problem is that http and https work completely different, so a pure redirection using the
firewall does not work, instead a valid http-redirection message needs to be send. Sending
this valid http message is the task of the redirection and needs to be listening at a different port:</p>
<pre><code>client --[some port]--&gt; firewall rules --[redirection.listen_port]--&gt; redirection endpoint
                                                                           |
       &lt;-------[ valid http message, redirecting to the http endpoint ]----/
</code></pre><p>The redirection follows the same idea as the port and listen_port above. So WaTTS is listening
at redirection.listen_port for incomming traffic and sending a valid http redirection message back,
which tells the browser to go tho the ssl endpoint: <a href="https://`hostname`:`port`" target="_blank">https://`hostname`:`port`</a>.</p>
<p>For the redirection another firewall rule is needed:</p>
<pre><code># redirecting all traffic arriving at the default http port, 80, to the the listen port
# for redirection
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port `redirection.listen_port`
</code></pre><h4 id="example">Example</h4>
<p>The following example is the basic SSL setup.</p>
<pre><code>hostname = my-watts.example.com
listen_port = 8443
port = 443
ssl = true
# using default values for cachain_file, cert_file and key_file
session_timeout = 10m
redirection.enable = true
redirection.listen_port = 8000
</code></pre><p>and the firewall rules</p>
<pre><code># for the ssl traffic forwarding from 443 to the listen port of WaTTS
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j REDIRECT --to-port 8443

# for the non ssl traffic trying port 80 forwarding it to the redirection.listen_port of WaTTS
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8000
</code></pre><h3 id="openid-connect-provider">OpenId Connect Provider</h3>
<h4 id="introduction">Introduction</h4>
<p>To provide a login mechanism for the user, at least one OpenId Connect Provider
is needed.</p>
<p>WaTTS needs to be registered as a client with OpenId Connect Provider. For this,
you need to perform the registration process at the Provider of your choice. The
registration process depends heavily on the Provider and is out of the scope of this
documentation, if you are unsure you can ask the provider.</p>
<p>During the registration, some information needs to be provided.
The redirect <em>uri</em> is created from three settings:</p>
<ul>
<li><code>ssl</code>: http:// (false, default) or https:// (true)</li>
<li><code>hostname</code>: localhost (default)</li>
<li><code>port</code>: 8080 (default)</li>
<li>fix path: /oidc</li>
</ul>
<p>For the default settings this results in the redirect uri:
<a href="http://localhost:8080/oidc" target="_blank">http://localhost:8080/oidc</a>.</p>
<p>The redirect uri for the settings &apos;SSL = true&apos;, &apos;Port = 443&apos;, &apos;HostName=<a href="GLOSSARY.html#tts" class="glossary-term" title="shortage for Token Translation Service">tts</a>.example.com&apos;
would be <a href="https://tts.example.com/oidc" target="_blank">https://tts.example.com/oidc</a> (the port is not added as it is the default
port for https, it would be the same for port 80 on SSL = false).</p>
<p>If you are unsure, just start the WaTTS and check the logs. During the start of WaTTS, it prints
some messages starting with <code>Init:</code>, one of them is <code>Init: using local endpoint ....</code>
telling you which uri to use.</p>
<p>WaTTS uses the &apos;code-auth-flow&apos; and is a &apos;web-application&apos;.</p>
<h4 id="general-settings">General Settings</h4>
<p>WaTTS verifies the complete SSL chain if https is used and is very strict to ensure the
integrity for the user using WaTTS.</p>
<p>To be able to verify a remote certificate WaTTS needs to know where the supported certification
authority certificates are stored. The second information WaTTS needs is the allowed depth of
CA and intermediate CAs to have before reaching the server certificate.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th>Description</th>
<th style="text-align:center">Datatype</th>
<th style="text-align:center">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">oidc.cacertfile</td>
<td>The file containing all trusted CAs</td>
<td style="text-align:center">file</td>
<td style="text-align:center">none</td>
</tr>
<tr>
<td style="text-align:center">oidc.cert_depth</td>
<td>The number of intermediate CAs allowd</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">oidc.cache_duration</td>
<td>The time, in seconds, http request to userinfo/tokeninfo are allowed to get cacheed. The purpose is to keep high load from the OpenId Connect Provider. Yet this also means that there is a 90 second window in which a user might still be allowed to perform actions although he has been blocked at the IdP</td>
<td style="text-align:center">integer, &apos;none&apos;</td>
<td style="text-align:center">90</td>
</tr>
<tr>
<td style="text-align:center">oidc.cache_clean</td>
<td>The amount of time (in seconds) to wait before cleaning up the cache</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">300</td>
</tr>
<tr>
<td style="text-align:center">oidc.request_timeout</td>
<td>The number of seconds an http request is allowed to take</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">300</td>
</tr>
<tr>
<td style="text-align:center">oidc.use_cookie</td>
<td>If cookies should be used to identify the user during login</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">oidc.check_user_agent</td>
<td>Wether the user agent identifier should be verified</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">oidc.check_peer_ip</td>
<td>Should the remote IP be checked when logging in the user</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">true</td>
</tr>
</tbody>
</table>
<h4 id="example">Example</h4>
<pre><code># this should be the setting on debian based systems if you want to trust the default bundle
oidc.cacertfile = /etc/ssl/certs/ca-certificates.crt
# this should be the setting on centos systems if you want to trust the default bundle
oidc.cacertfile = /etc/ssl/certs/ca-bundle.crt

# on both systems you can cange the allowed depth by
oidc.cert_depth = 5
</code></pre><h4 id="provider-settings">Provider Settings</h4>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th>Description</th>
<th style="text-align:center">Datatype</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">description</td>
<td>A description of the Provider, shown at the login Screen</td>
<td style="text-align:center">string</td>
</tr>
<tr>
<td style="text-align:center">client_id</td>
<td>The client id received at the registration</td>
<td style="text-align:center">string</td>
</tr>
<tr>
<td style="text-align:center">client_secret</td>
<td>The client secret received at the registration</td>
<td style="text-align:center">string</td>
</tr>
<tr>
<td style="text-align:center">config_endpoint</td>
<td>The configuration endpoint of the provider, ensure you are using ssl</td>
<td style="text-align:center">url</td>
</tr>
<tr>
<td style="text-align:center">request_scopes</td>
<td>the scopes to request</td>
<td style="text-align:center">comma separated list</td>
</tr>
</tbody>
</table>
<p>Each setting is prefixed with &apos;openid.<code>id</code>.&apos; where <code>id</code> must be replaced by the id
you want to give to the provider. The <code>id</code> MUST not be &apos;any&apos; or start with &apos;rsp&apos;.</p>
<h4 id="example">Example</h4>
<p>An example for the IAM OpenId Connect Provider, setting its id to <code>iam</code>:</p>
<pre><code>openid.iam.description = INDIGO Datacloud Identity and Access Management (IAM)
openid.iam.client_id = &lt;insert the client id&gt;
opemid.iam.client_secret =  &lt;insert the client secret&gt;
openid.iam.config_endpoint = https://iam-test.indigo-datacloud.eu/.well-known/openid-configuration
openid.iam.request_scopes = openid, profile
</code></pre><h3 id="relying-service-providers">Relying Service Providers</h3>
<h4 id="introduction">Introduction</h4>
<p>A relying service provider (RSP) is a service that relys on WaTTS for either performing some
task or even completely for authentication.</p>
<h4 id="settings">Settings</h4>
<p>Each setting is prefixed with &apos;rsp.<code>id</code>.&apos; where <code>id</code> must be replaced by the id
you want to give to the relying service provider.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th>Description</th>
<th style="text-align:center">Datatype</th>
<th style="text-align:center">Mandatory (Default)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">keys_location</td>
<td>the location of the file / web-page containing the json object with the public keys (see below). the location must be a url with either &apos;https://&apos; or &apos;file://&apos; scheme.</td>
<td style="text-align:center">url</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">show_ui</td>
<td>if set to &apos;false&apos; no user-interface will be shown.</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">no (true)</td>
</tr>
<tr>
<td style="text-align:center">perform_login</td>
<td>If set to &apos;false&apos; the user won&apos;t be redirected to a login.</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">no (true)</td>
</tr>
<tr>
<td style="text-align:center">base_url</td>
<td>The url each url passed to WaTTS in the JWT must start with.</td>
<td style="text-align:center">string</td>
<td style="text-align:center">yes</td>
</tr>
</tbody>
</table>
<h4 id="example">Example</h4>
<p>An example for an RSP, setting its id to <code>simple</code>:</p>
<pre><code>rsp.simple.keys_location = https://simple-rsp.kit.edu/jwk
rsp.simple.perform_login = false
rsp.simple.show_ui = true
rsp.simple.base_url = https://simple-rsp.kit.edu
</code></pre><h3 id="services">Services</h3>
<h4 id="introduction">Introduction</h4>
<p>A service is a single entity for which a user can request credentials.
The configuration of a service consists of one group of <em>service</em> settings.</p>
<p>To create credentials, WaTTS connects to the service, either locally or
remotely using <em>ssh</em>. After the connection is established, a command is
executed and the subsequent result is parsed and interpreted.</p>
<p>The executed commands are also called <em>plugins</em>; for further information on how
the plugins work and how to implement them, see the documentation for developers.</p>
<p>The plugins are not part of WaTTS, so they can be changed independant of WaTTS and
also maintained by the community.</p>
<p>Known plugins(use them at your own risk):</p>
<ul>
<li><a href="https://github.com/indigo-dc/tts_plugin_info" target="_blank">Info plugin</a></li>
<li><a href="https://github.com/indigo-dc/tts_plugin_opennebula" target="_blank">OpenNebula</a></li>
<li><a href="https://github.com/indigo-dc/tts_plugin_ca" target="_blank">Simple CA</a></li>
</ul>
<p>Feel free to add an issue to get your plugin listed above.</p>
<h4 id="settings">Settings</h4>
<p>Each setting is prefixed with &apos;service.<code>id</code>.&apos; where <code>id</code> must be replaced by the id
you want to give to the service.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th>Description</th>
<th style="text-align:center">Datatype</th>
<th style="text-align:center">Mandatory</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">description</td>
<td>A description of the service for the user</td>
<td style="text-align:center">string</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">cmd</td>
<td>The command to execute after connecting, needs to be executable/readable by the user WaTTS is running as</td>
<td style="text-align:center">string</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">cmd_env_use</td>
<td>The parameter will not be passed at the command line but put into an environment variable. The default is &apos;false&apos;.</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">cmd_env_var</td>
<td>The name of the environment variable containing the parameter, only used if <code>cmd_env_use</code> is true</td>
<td style="text-align:center">string</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">credential_limit</td>
<td>The maximum number of retrievable credentials</td>
<td style="text-align:center">integer or &apos;infinite&apos;</td>
<td style="text-align:center">no (infinite)</td>
</tr>
<tr>
<td style="text-align:center">parallel_runner</td>
<td>The number of parallel runs of the plugin for the service</td>
<td style="text-align:center">integer or &apos;infinite&apos;</td>
<td style="text-align:center">no, (1)</td>
</tr>
<tr>
<td style="text-align:center">allow_same_state</td>
<td>Whether the plugin is allowed to return the same state more than once</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">no, (false)</td>
</tr>
<tr>
<td style="text-align:center">plugin_timeout</td>
<td>The time after which WaTTS won&apos;t wait for the result of the plugin execution anymore</td>
<td style="text-align:center">duration or &apos;infinity&apos;</td>
<td style="text-align:center">no (infinity)</td>
</tr>
<tr>
<td style="text-align:center">pass_access_token</td>
<td>Whether the  access token should be passed to the plugin. Enabling this is adding a security risk!</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">no (false)</td>
</tr>
<tr>
<td style="text-align:center">connection.type</td>
<td>Either local or ssh</td>
<td style="text-align:center">&apos;local&apos; or &apos;ssh&apos;</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">connection.user</td>
<td>The user name to use when connecting e.g. with ssh</td>
<td style="text-align:center">string</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">connection.password</td>
<td>The password to use when connecting e.g. with ssh</td>
<td style="text-align:center">string</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">connection.host</td>
<td>The hostname to connect to e.g. with ssh</td>
<td style="text-align:center">host</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">connection.port</td>
<td>The port number to connect to e.g. with ssh</td>
<td style="text-align:center">port</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">connection.ssh_dir</td>
<td>The ssh_dir to use with ssh</td>
<td style="text-align:center">port</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">connection.ssh_key_pass</td>
<td>The password of the private key to use with ssh</td>
<td style="text-align:center">string</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">plugin.<code>key</code></td>
<td>A setting to send to the plugin, the name of the parameter will be <code>key</code>. Which values and which keys are supported depend on the plugin. If no parameter are set warning about using default values are issued in the logs</td>
<td style="text-align:center">any</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">authz.allow.<code>p</code>.<code>k</code>.<code>o</code></td>
<td>See the Authorization section</td>
<td style="text-align:center">other</td>
<td style="text-align:center">no ([])</td>
</tr>
<tr>
<td style="text-align:center">authz.forbid.<code>p</code>.<code>k</code>.<code>o</code></td>
<td>See the Authorization section</td>
<td style="text-align:center">other</td>
<td style="text-align:center">no ([])</td>
</tr>
<tr>
<td style="text-align:center">authz.hide</td>
<td>Hide the service if the user is not allowed</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">no (false)</td>
</tr>
<tr>
<td style="text-align:center">authz.tooltip</td>
<td>Message that is shown when hovering the row of the service that is not allowed, used to give users a hint on how they might get access to the service</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">no (false)</td>
</tr>
</tbody>
</table>
<h4 id="authorization">Authorization</h4>
<p>Authorization follows a few simple steps:</p>
<ol>
<li>at first everyone is forbidden</li>
<li>if an <code>allow</code> rule that matches the user evaluates to true, she is allowed</li>
<li>if a <code>forbid</code> rule that matches the user evaluates to true, he is forbidden</li>
</ol>
<p>So a for a user to access a service she:</p>
<ul>
<li>MUST match at least one <code>allow</code> rule</li>
<li>MUST NOT match any <code>forbid</code> rule</li>
</ul>
<p>Each rule is exactly one line long. A rule always consists of five parts:
<code>authz.allow.p.k.o = v</code>, where the values are:</p>
<ul>
<li><code>p</code>: the Id of the provider, this can either be an OpenID Connect provider or an rsp</li>
<li><code>k</code>: the key within the OpenId Connect Id-Token or user information</li>
<li><code>info</code>: the information in the Id Token or user information with the key <code>k</code></li>
<li><code>o</code>: the operation to perform</li>
<li><code>v</code>: the value</li>
</ul>
<p>The provider Id for an OpenID Connect provider is the same as was given during the configuration,
in the provider example above the <em>id</em> was <code>iam</code>, so using that for <code>p</code> allows making decisions
on users coming from <code>iam</code>.</p>
<p>The provider Id for an RSP is the id of the RSP prefixed with an &apos;rsp-&apos;. So the simple RSP in
the example above would have the <em>id</em> <code>rsp-simple</code>. All connections from an RSP get logged in
by the information sent by the RSP, an additional login at configured OpenID Connect providers
can be performed.</p>
<p>There is a special provider <em>id</em> value, <code>any</code>, which matches any provider, meaning any OpenID
Connect or RSP provider.</p>
<p>The key <code>k</code> has to match a value of the <em>id</em> token or the user info. The value of the
<em>Id Token</em> offers <em>Userinfo</em>, i.e. having the key <code>k</code> is the <code>info</code>.
If the key is not present:</p>
<ul>
<li><code>allow</code> rule evaluates to <em>false</em></li>
<li><code>forbid</code> rule evaluates to <em>true</em></li>
</ul>
<p>The operation <code>o</code> can be one of the following list:</p>
<ul>
<li><code>contains</code>: the <code>info</code> can either be a list or a string<ul>
<li>a <em>list</em>: the value <code>v</code> must be a member of the list <code>info</code></li>
<li>a <em>string</em>: the value <code>v</code> must be part of the string <code>info</code></li>
</ul>
</li>
<li><code>is_member_of</code>: the value <code>v</code> must be a comma separated list (with no spaces!) and <code>info</code> needs to be a member of that list</li>
<li><code>equals</code>: <code>v</code> and <code>info</code> need to be equal</li>
<li><code>regexp</code>: <code>v</code> is a regular expression and <code>info</code> needs to satisfy the expression</li>
<li><code>any</code>: evaluates to <code>v</code>, so to make this pass set <code>v</code> to &apos;true&apos;</li>
</ul>
<h4 id="examples">Examples</h4>
<pre><code># &apos;p&apos; is any, so matching all providers
# &apos;k&apos; is sub, the subject of the id token, this is always present
# &apos;info&apos; can be ignored due to
  # &apos;o&apos; being &apos;any&apos;
  # &apos;v&apos; is true
# The following line is an example allowing anyone from any provider:
service.info.authz.allow.any.sub.any = true


# &apos;p&apos; is iam, so matching only the provider with the id iam
# &apos;k&apos; is sub, the subject of the id token, which for sure is always present
# &apos;info&apos; can be ignored due to
  # &apos;o&apos; being &apos;any&apos;
  # &apos;v&apos; is true
# The next line shows an example allowing anyone from the iam provider:
service.info.authz.allow.iam.sub.any = true

# The examples below will concentrate on the operations.

# &apos;k&apos; is a group, i.e. the groups the user belongs to
# &apos;info&apos; should be a list
# &apos;o&apos; has value &apos;contains&apos;
# &apos;v&apos; is &apos;Developer&apos;
# The following line allows anyone whose group list contains &apos;Developer&apos; and is
# from the iam provider
service.info.authz.allow.iam.group.contains = Developer

# &apos;k&apos; is sub
# &apos;info&apos; is the subject within iam
# &apos;o&apos; being &apos;is_member_of&apos;
# &apos;v&apos; is a comma separated list of subjects
# The following line allows sub1, sub2 and sub3 from the provider iam
service.info.authz.allow.iam.sub.is_member_of = sub1,sub3,sub2
</code></pre><h4 id="complete-example">Complete Example</h4>
<pre><code>service.info.description = Simple Info Service
service.info.credential_limit = 1
service.info.connection.type = local
service.info.cmd = /home/watts/.config/watts/info.py
service.info.parallel_runner = infinite
service.info.authz.allow.any.sub.any = true
# the following will be sent to the plugin
service.plugin.path = /tmp/data
</code></pre><h3 id="complete-config-example">Complete Config Example</h3>
<p>This example uses the info plugin, which is a very simple plugin and can be downloaded <a href="https://github.com/indigo-dc/tts_plugin_info" target="_blank">here</a>.</p>
<pre><code>hostname = watts.example.com
port = 443
listen_port = 8443
redirection.enable = true
redirection.listen_port = 8080

ssl = true
cachain_file = /home/watts/cert/ca-bundle.crt
cert_file = /home/watts/cert/server.crt
key_file = /home/watts/cert/server.key

oidc.cacertfile = /etc/ss/certs/ca-certificates.crt
oidc.cert_depth = 3

sqlite_file = /home/watts/watts.db

openid.iam.description = INDIGO Datacloud Identity and Access Management (IAM)
openid.iam.client_id = e70e7190-d64cad3771b9
openid.iam.client_secret = AN5pY379_Z_1jgiiAyKBEHe8zKP2KuiWxV34zWzw
openid.iam.config_endpoint = https://iam.indigo-datacloud.eu/.well-known/openid-configuration
openid.iam.request_scopes = openid, profile

service.info.description = Simple Info Service
service.info.credential_limit = 1
service.info.connection.type = local
service.info.cmd = /home/watts/info.py
service.info.parallel_runner = infinite
service.info.authz.allow.any.sub.any = true
</code></pre><h3 id="configuring-ssh-for-watts">Configuring SSH for WaTTS</h3>
<p>WaTTS does not yet support hashed hosts in the <code>known_hosts</code> file. As the
connection to the remote host is done without user interaction, the host MUST be
listed in the <code>known_hosts</code> file.</p>
<p>To add a host to the list of known hosts in a way readable for WaTTS, the
<code>ssh_config</code> (usually located in <code>/etc/ssh/ssh_config</code>) must have the setting
<code>HashKnownHosts no</code>. After checking and eventually updating the configuration,
one can login as a WaTTS user.</p>
<p>As a WaTTS user, one connects to remote hosts using the <a href="GLOSSARY.html#credential" class="glossary-term" title="Any kind of information used to gain access to a service, such as e.g.
username/password for ssh">credential</a> specified in the
service configuration, with potentially using the verbose flag (-v). During the
connection there are two possibilities:</p>
<ol>
<li>The client asks whether the host should be added. In the case it is a host that
should be accessible by WaTTS, the user should answer with yes, and then
can go on with the next host.</li>
<li>The client silently connects without asking. If this is the case, the host is
already in the <code>~/.ssh/known_hosts</code> file. In the verbose connection, the
output will tell which line in the file belongs to the remote host. In this
case you can edit the <code>known_hosts</code> file and delete the line at the number
printed before. Save the file and start the connection again, and the
situation described above will happen.</li>
</ol>
<p>After adding all the hosts, the <code>ssh_config</code> should be modified. Open the
<code>ssh_config</code> and change the hash hosts setting to <code>HashKnownHosts yes</code>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="admin.html" class="navigation navigation-prev " aria-label="Previous page: Deployment And Administration Guide">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="developer.html" class="navigation navigation-next " aria-label="Next page: Developer Guide">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Configuration Guide","level":"1.4","depth":1,"next":{"title":"Developer Guide","level":"1.5","depth":1,"path":"developer.md","ref":"developer.md","articles":[]},"previous":{"title":"Deployment And Administration Guide","level":"1.3","depth":1,"path":"admin.md","ref":"admin.md","articles":[]},"dir":"ltr"},"config":{"plugins":[],"root":"./gitbook","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"config.md","mtime":"2017-07-06T06:36:27.864Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-07-06T06:54:05.175Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

