<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module watts</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module watts</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>This module is the main entry point for any kind action to happen.


<h2><a name="description">Description</a></h2>This module is the main entry point for any kind action to happen.
  Including logggin in, requesting and revoking of credentials.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-credential">credential()</a></h3>
<p><tt>credential() = #{cred_id =&gt; CredId::binary(), ctime =&gt; CTime::binary(), interface =&gt; Interface::binary(), service_id =&gt; ServiceId::binary(), cred_state =&gt; CredState::binary()}</tt></p>


<h3 class="typedecl"><a name="type-session_info">session_info()</a></h3>
<p><tt>session_info() = #{session_pid =&gt; Session::pid(), session_type =&gt; <a href="watts_session.html#type-type">watts_session:type()</a>}</tt></p>


<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#create_information_result-4">create_information_result/4*</a></td><td></td></tr>
<tr><td valign="top"><a href="#credential_error_message-1">credential_error_message/1*</a></td><td></td></tr>
<tr><td valign="top"><a href="#credential_error_message-2">credential_error_message/2*</a></td><td></td></tr>
<tr><td valign="top"><a href="#do_additional_login-4">do_additional_login/4*</a></td><td></td></tr>
<tr><td valign="top"><a href="#do_login-4">do_login/4*</a></td><td>perform a first login, fetching all the information needed.</td></tr>
<tr><td valign="top"><a href="#do_login_if_issuer_enabled-3">do_login_if_issuer_enabled/3*</a></td><td>start the login process but only if the issuer is enabled.</td></tr>
<tr><td valign="top"><a href="#do_rsp_additional_login-4">do_rsp_additional_login/4*</a></td><td>perform an additional login via oidc for an RSP session
  adding additional login information to the session.</td></tr>
<tr><td valign="top"><a href="#does_credential_exist-2">does_credential_exist/2</a></td><td></td></tr>
<tr><td valign="top"><a href="#does_temp_cred_exist-2">does_temp_cred_exist/2</a></td><td></td></tr>
<tr><td valign="top"><a href="#empty_session-0">empty_session/0*</a></td><td>helper function initializing a session without user.</td></tr>
<tr><td valign="top"><a href="#extract_userinfo-1">extract_userinfo/1*</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_access_token_for-1">get_access_token_for/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_credential_list_for-1">get_credential_list_for/1</a></td><td>get the list of credentials for the given session.</td></tr>
<tr><td valign="top"><a href="#get_display_name_for-1">get_display_name_for/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_interface_description-1">get_interface_description/1*</a></td><td>convert interface type in human readable string.</td></tr>
<tr><td valign="top"><a href="#get_iss_id_sub_for-1">get_iss_id_sub_for/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_iss_sub_for-1">get_iss_sub_for/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_openid_provider_info-1">get_openid_provider_info/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_openid_provider_list-0">get_openid_provider_list/0</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_service_list_for-1">get_service_list_for/1</a></td><td>returns the list of services for the given Session.</td></tr>
<tr><td valign="top"><a href="#get_temp_cred-2">get_temp_cred/2</a></td><td></td></tr>
<tr><td valign="top"><a href="#get_user_msg-1">get_user_msg/1*</a></td><td></td></tr>
<tr><td valign="top"><a href="#handle_credential_result-4">handle_credential_result/4*</a></td><td>handle the result of a translation.</td></tr>
<tr><td valign="top"><a href="#introspect_token_if_needed-4">introspect_token_if_needed/4*</a></td><td></td></tr>
<tr><td valign="top"><a href="#is_provider_disabled-1">is_provider_disabled/1*</a></td><td>return if a provider is disabled, returns true if not found.</td></tr>
<tr><td valign="top"><a href="#login_with_access_token-2">login_with_access_token/2</a></td><td>login with an access token, which is use at the API.</td></tr>
<tr><td valign="top"><a href="#login_with_oidcc-2">login_with_oidcc/2</a></td><td>perform a login with the openid flow through the ui (not access token).</td></tr>
<tr><td valign="top"><a href="#logout-1">logout/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#new_login-3">new_login/3*</a></td><td>start e new login, so setting up a session is needed.</td></tr>
<tr><td valign="top"><a href="#request_credential_for-3">request_credential_for/3</a></td><td>start a translation request at the given Service for the given Session.</td></tr>
<tr><td valign="top"><a href="#retrieve_information-4">retrieve_information/4*</a></td><td></td></tr>
<tr><td valign="top"><a href="#return_credential_list-2">return_credential_list/2*</a></td><td>get the list of credentials for the given session unless it is RSP.</td></tr>
<tr><td valign="top"><a href="#return_service_list-2">return_service_list/2*</a></td><td>returns the list of services for the given Session unless it is RSP.</td></tr>
<tr><td valign="top"><a href="#return_session_info-1">return_session_info/1*</a></td><td>generate a session description map from the given session pid.</td></tr>
<tr><td valign="top"><a href="#revoke_credential_for-2">revoke_credential_for/2</a></td><td></td></tr>
<tr><td valign="top"><a href="#rsp_session_if_service_allowed-2">rsp_session_if_service_allowed/2*</a></td><td>return the rsp session, if the first parameter is true.</td></tr>
<tr><td valign="top"><a href="#rsp_session_or_error-6">rsp_session_or_error/6*</a></td><td>either setup the rsp session or return an error.</td></tr>
<tr><td valign="top"><a href="#session_for_rsp-1">session_for_rsp/1</a></td><td>setup a session for an rsp, get called when performing rsp logins.</td></tr>
<tr><td valign="top"><a href="#session_with_error-1">session_with_error/1</a></td><td>create a basic session that only contains the error message.</td></tr>
<tr><td valign="top"><a href="#start_debug-1">start_debug/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#start_debug-2">start_debug/2</a></td><td></td></tr>
<tr><td valign="top"><a href="#stop_debug-0">stop_debug/0</a></td><td></td></tr>
<tr><td valign="top"><a href="#store_temp_cred-2">store_temp_cred/2</a></td><td></td></tr>
<tr><td valign="top"><a href="#trigger_rsp_additional_login-6">trigger_rsp_additional_login/6*</a></td><td>check if the RSP is enabled and trigger the additional login.</td></tr>
<tr><td valign="top"><a href="#update_session-4">update_session/4*</a></td><td></td></tr>
<tr><td valign="top"><a href="#update_session-5">update_session/5*</a></td><td></td></tr>
<tr><td valign="top"><a href="#update_session_type-2">update_session_type/2*</a></td><td></td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="create_information_result-4">create_information_result/4 *</a></h3>
<div class="spec">
<p><tt>create_information_result(X1, TokenResult, TokenMap, IssuerId) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="credential_error_message-1">credential_error_message/1 *</a></h3>
<div class="spec">
<p><tt>credential_error_message(Reason) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="credential_error_message-2">credential_error_message/2 *</a></h3>
<div class="spec">
<p><tt>credential_error_message(X1, BaseWMsg) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="do_additional_login-4">do_additional_login/4 *</a></h3>
<div class="spec">
<p><tt>do_additional_login(Issuer, Subject0, Token0, SessPid) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="do_login-4">do_login/4 *</a></h3>
<div class="spec">
<p><tt>do_login(Issuer::binary(), Subject::binary() | undefined, Token::#{} | binary(), Session::pid()) -&gt; {ok, <a href="#type-session_info">session_info()</a>} | {error, Reason::atom()}</tt><br></p>
</div><p>perform a first login, fetching all the information needed.</p>

<h3 class="function"><a name="do_login_if_issuer_enabled-3">do_login_if_issuer_enabled/3 *</a></h3>
<div class="spec">
<p><tt>do_login_if_issuer_enabled(Issuer::binary(), Subject::binary() | undefined, Token::#{} | binary()) -&gt; {ok, <a href="#type-session_info">session_info()</a>} | {error, Reason::atom()}</tt><br></p>
</div><p>start the login process but only if the issuer is enabled.</p>

<h3 class="function"><a name="do_rsp_additional_login-4">do_rsp_additional_login/4 *</a></h3>
<div class="spec">
<p><tt>do_rsp_additional_login(Issuer::binary(), Subject::binary(), TokenMap::#{}, Session::pid()) -&gt; {ok, <a href="#type-session_info">session_info()</a>} | {error, Reason::atom()}</tt><br></p>
</div><p>perform an additional login via oidc for an RSP session
  adding additional login information to the session. Enforcing
  that the RSP is enabled.</p>

<h3 class="function"><a name="does_credential_exist-2">does_credential_exist/2</a></h3>
<div class="spec">
<p><tt>does_credential_exist(Id, Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="does_temp_cred_exist-2">does_temp_cred_exist/2</a></h3>
<div class="spec">
<p><tt>does_temp_cred_exist(Id, Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="empty_session-0">empty_session/0 *</a></h3>
<div class="spec">
<p><tt>empty_session() -&gt; {ok, Session::pid()}</tt><br></p>
</div><p>helper function initializing a session without user.</p>

<h3 class="function"><a name="extract_userinfo-1">extract_userinfo/1 *</a></h3>
<div class="spec">
<p><tt>extract_userinfo(Unknown) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_access_token_for-1">get_access_token_for/1</a></h3>
<div class="spec">
<p><tt>get_access_token_for(Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_credential_list_for-1">get_credential_list_for/1</a></h3>
<div class="spec">
<p><tt>get_credential_list_for(Session::pid()) -&gt; {ok, [Credential::#{}]}</tt><br></p>
</div><p>get the list of credentials for the given session</p>

<h3 class="function"><a name="get_display_name_for-1">get_display_name_for/1</a></h3>
<div class="spec">
<p><tt>get_display_name_for(Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_interface_description-1">get_interface_description/1 *</a></h3>
<div class="spec">
<p><tt>get_interface_description(X1::{ok, atom() | tuple()}) -&gt; binary()</tt><br></p>
</div><p>convert interface type in human readable string.</p>

<h3 class="function"><a name="get_iss_id_sub_for-1">get_iss_id_sub_for/1</a></h3>
<div class="spec">
<p><tt>get_iss_id_sub_for(Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_iss_sub_for-1">get_iss_sub_for/1</a></h3>
<div class="spec">
<p><tt>get_iss_sub_for(Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_openid_provider_info-1">get_openid_provider_info/1</a></h3>
<div class="spec">
<p><tt>get_openid_provider_info(ProviderId) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_openid_provider_list-0">get_openid_provider_list/0</a></h3>
<div class="spec">
<p><tt>get_openid_provider_list() -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_service_list_for-1">get_service_list_for/1</a></h3>
<div class="spec">
<p><tt>get_service_list_for(Session::pid()) -&gt; {ok, [Service::#{}]}</tt><br></p>
</div><p>returns the list of services for the given Session</p>

<h3 class="function"><a name="get_temp_cred-2">get_temp_cred/2</a></h3>
<div class="spec">
<p><tt>get_temp_cred(Id, Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="get_user_msg-1">get_user_msg/1 *</a></h3>
<div class="spec">
<p><tt>get_user_msg(X1) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="handle_credential_result-4">handle_credential_result/4 *</a></h3>
<div class="spec">
<p><tt>handle_credential_result(X1, ServiceId, Session, Params) -&gt; any()</tt></p>
</div><p>handle the result of a translation.
  this is the result part of the <a href="#request_credential_for-3"><code>request_credential_for/3</code></a> call.
  -spec handle_credential_result({ok, Credential::map()} |
                                 {error, Reason :: atom()},
                                  ServiceId :: binary(),
                                 Session :: pid(), Params :: [map()]) -&gt;
                                        {ok, map()} | {error, map()}.
  -spec handle_credential_result(watts_plugin:result(), binary(), pid(), map())
  -&gt; ok.</p>

<h3 class="function"><a name="introspect_token_if_needed-4">introspect_token_if_needed/4 *</a></h3>
<div class="spec">
<p><tt>introspect_token_if_needed(X1, Token, Config, Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="is_provider_disabled-1">is_provider_disabled/1 *</a></h3>
<div class="spec">
<p><tt>is_provider_disabled(ProviderId::binary()) -&gt; boolean()</tt><br></p>
</div><p>return if a provider is disabled, returns true if not found.</p>

<h3 class="function"><a name="login_with_access_token-2">login_with_access_token/2</a></h3>
<div class="spec">
<p><tt>login_with_access_token(AccessToken::binary() | atom(), Issuer::binary()) -&gt; {ok, <a href="#type-session_info">session_info()</a>} | {error, Reason::atom()}</tt><br></p>
</div><p>login with an access token, which is use at the API.
  this function in turn calls <a href="#do_login_if_issuer_enabled-3"><code>do_login_if_issuer_enabled/3</code></a>.</p>

<h3 class="function"><a name="login_with_oidcc-2">login_with_oidcc/2</a></h3>
<div class="spec">
<p><tt>login_with_oidcc(TokenMap::#{}, X2::{SessType::<a href="watts_session.html#type-type">watts_session:type()</a>, Session::pid() | undefined}) -&gt; {ok, <a href="#type-session_info">session_info()</a>} | {error, Reason::atom()}</tt><br></p>
</div><p>perform a login with the openid flow through the ui (not access token).
  there are some possible valid cases, if the Token contains the minimal
  needed information:
  <ul>
  <li> a first login, then the session type is none,
  calling <a href="#do_login_if_issuer_enabled-3"><code>do_login_if_issuer_enabled/3</code></a> </li>
  <li> an additional login, then the session type is oidc,
  calling <a href="#do_additional_login-4"><code>do_additional_login/4</code></a> </li>
  <li> an additional login at an rsp session, session type is {rsp, _, login},
  calling <a href="#do_rsp_additional_login-4"><code>do_rsp_additional_login/4</code></a> </li>
  <li> all other session types are considered an error </li>
  </ul>
 
  <p>It fails for sure if the Token does not contain the minimal needed  
information, which is at least subject and issuer in the IdToken.</p>
 
  The login at the api level with access token is performed using
  {link login_with_access_token/2}.</p>
<p><b>See also:</b> <a href="watts_session.html">watts_session</a>.</p>

<h3 class="function"><a name="logout-1">logout/1</a></h3>
<div class="spec">
<p><tt>logout(Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="new_login-3">new_login/3 *</a></h3>
<div class="spec">
<p><tt>new_login(Issuer::binary(), Subject::binary() | undefined, Token::#{} | binary()) -&gt; {error, Reason::atom()} | {ok, <a href="#type-session_info">session_info()</a>}</tt><br></p>
</div><p>start e new login, so setting up a session is needed.
  it is not needed for e.g. additional logins.</p>

<h3 class="function"><a name="request_credential_for-3">request_credential_for/3</a></h3>
<div class="spec">
<p><tt>request_credential_for(ServiceId::binary(), Session::pid(), Params::[#{}]) -&gt; {ok, #{}} | {error, #{}}</tt><br></p>
</div><p>start a translation request at the given Service for the given Session.
  This is using the params passed.
  A plugin will be triggered to run with all the needed parameter.
  After running the plugin the result will get parsed and send to the user.</p>
<p><b>See also:</b> <a href="watts_plugin.html">watts_plugin</a>, <a href="watts_plugin_runner.html">watts_plugin_runner</a>, <a href="watts_plugin.html#request-4">watts_plugin:request/4</a>.</p>

<h3 class="function"><a name="retrieve_information-4">retrieve_information/4 *</a></h3>
<div class="spec">
<p><tt>retrieve_information(Issuer, Subject, Token, Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="return_credential_list-2">return_credential_list/2 *</a></h3>
<div class="spec">
<p><tt>return_credential_list(Session::pid(), Type::atom() | tuple()) -&gt; {ok, [Credential::#{}]}</tt><br></p>
</div><p>get the list of credentials for the given session unless it is RSP</p>

<h3 class="function"><a name="return_service_list-2">return_service_list/2 *</a></h3>
<div class="spec">
<p><tt>return_service_list(Session::pid(), Type::atom() | {rsp, term(), term()}) -&gt; {ok, [Service::#{}]}</tt><br></p>
</div><p>returns the list of services for the given Session unless it is RSP</p>

<h3 class="function"><a name="return_session_info-1">return_session_info/1 *</a></h3>
<div class="spec">
<p><tt>return_session_info(Session::pid()) -&gt; {ok, <a href="#type-session_info">session_info()</a>}</tt><br></p>
</div><p>generate a session description map from the given session pid.</p>

<h3 class="function"><a name="revoke_credential_for-2">revoke_credential_for/2</a></h3>
<div class="spec">
<p><tt>revoke_credential_for(CredId, Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="rsp_session_if_service_allowed-2">rsp_session_if_service_allowed/2 *</a></h3>
<div class="spec">
<p><tt>rsp_session_if_service_allowed(ServiceAllowed::boolean(), Session::pid()) -&gt; {ok, Session::pid()} | {error, Reason::atom()}</tt><br></p>
</div><p>return the rsp session, if the first parameter is true.
  The first parameter is the boolean value if the service is allowed.</p>

<h3 class="function"><a name="rsp_session_or_error-6">rsp_session_or_error/6 *</a></h3>
<div class="spec">
<p><tt>rsp_session_or_error(ValidProvider::boolean(), ServiceId::binary() | undefined, Params::#{} | undefined, Provider::binary() | undefined, Rsp::<a href="watts_rsp.html#type-rsp">watts_rsp:rsp()</a>, SessType::<a href="watts_session.html#type-type">watts_session:type()</a>) -&gt; {ok, Session::pid()} | {error, Reason::atom()}</tt><br></p>
</div><p>either setup the rsp session or return an error.</p>

<h3 class="function"><a name="session_for_rsp-1">session_for_rsp/1</a></h3>
<div class="spec">
<p><tt>session_for_rsp(Rsp::<a href="watts_rsp.html#type-rsp">watts_rsp:rsp()</a>) -&gt; {ok, Session::pid()} | {error, Reason::atom()}</tt><br></p>
</div><p>setup a session for an rsp, get called when performing rsp logins.
  RSP sessions always have a primary login that is coming from the RSP.
  If a user needs to authenticate against some OpenID Connect provider this
  always is an additional login for an RSP session.</p>
<p><b>See also:</b> <a href="watts_http_rsp.html#handle-2">watts_http_rsp:handle/2</a>, <a href="watts_rsp.html#validate_jwt_get_rsp-2">watts_rsp:validate_jwt_get_rsp/2</a>.</p>

<h3 class="function"><a name="session_with_error-1">session_with_error/1</a></h3>
<div class="spec">
<p><tt>session_with_error(Msg::binary()) -&gt; {ok, Session::pid()}</tt><br></p>
</div><p>create a basic session that only contains the error message.</p>

<h3 class="function"><a name="start_debug-1">start_debug/1</a></h3>
<div class="spec">
<p><tt>start_debug(ListOfModules) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="start_debug-2">start_debug/2</a></h3>
<div class="spec">
<p><tt>start_debug(ListOfModules, Options) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="stop_debug-0">stop_debug/0</a></h3>
<div class="spec">
<p><tt>stop_debug() -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="store_temp_cred-2">store_temp_cred/2</a></h3>
<div class="spec">
<p><tt>store_temp_cred(Credential, Session) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="trigger_rsp_additional_login-6">trigger_rsp_additional_login/6 *</a></h3>
<div class="spec">
<p><tt>trigger_rsp_additional_login(X1, Provider, X3, Subject, TokenMap, Pid) -&gt; any()</tt></p>
</div><p>check if the RSP is enabled and trigger the additional login.</p>

<h3 class="function"><a name="update_session-4">update_session/4 *</a></h3>
<div class="spec">
<p><tt>update_session(Issuer, Subject, Token, SessionPid) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="update_session-5">update_session/5 *</a></h3>
<div class="spec">
<p><tt>update_session(Issuer, IssId, Subject, Token, SessionPid) -&gt; any()</tt></p>
</div>

<h3 class="function"><a name="update_session_type-2">update_session_type/2 *</a></h3>
<div class="spec">
<p><tt>update_session_type(X1, SessPid) -&gt; any()</tt></p>
</div>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
