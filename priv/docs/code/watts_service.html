<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module watts_service</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module watts_service</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>this module handles the services.


<h2><a name="description">Description</a></h2>this module handles the services. It validates the parameter coming from
  the plugin as as the configuration itself.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-conf_parameter">conf_parameter()</a></h3>
<p><tt>conf_parameter() = #{name =&gt; binary(), type =&gt; binary(), default =&gt; any()}</tt></p>


<h3 class="typedecl"><a name="type-conf_parameters">conf_parameters()</a></h3>
<p><tt>conf_parameters() = [<a href="#type-conf_parameter">conf_parameter()</a>]</tt></p>


<h3 class="typedecl"><a name="type-connection">connection()</a></h3>
<p><tt>connection() = #{type =&gt; local | ssh, user =&gt; undefined | string(), passwd =&gt; undefined | string(), host =&gt; undefined | string(), port =&gt; undefined | integer(), ssh_dir =&gt; undefined | string(), ssh_key_pass =&gt; undefined | string()}</tt></p>


<h3 class="typedecl"><a name="type-info">info()</a></h3>
<p><tt>info() = #{id =&gt; binary(), description =&gt; binary(), cmd =&gt; binary(), cmd_env_use =&gt; boolean(), cmd_env_var =&gt; string(), cred_limit =&gt; infinite | integer(), allow_same_state =&gt; boolean(), plugin_conf =&gt; #{}, plugin_version =&gt; undefined | binary(), params =&gt; [<a href="#type-parameter_set">parameter_set()</a>], parallel_runner =&gt; infinite | integer(), pass_access_token =&gt; boolean(), plugin_timeout =&gt; infinity | integer(), connection =&gt; <a href="#type-connection">connection()</a>, authz =&gt; <a href="watts_service_authz.html#type-config">watts_service_authz:config()</a>, queue =&gt; atom(), enabled =&gt; boolean(), term() =&gt; term()}</tt></p>


<h3 class="typedecl"><a name="type-limited_info">limited_info()</a></h3>
<p><tt>limited_info() = #{id =&gt; binary(), description =&gt; binary(), cred_limit =&gt; infinite | integer(), pass_access_token =&gt; boolean(), enabled =&gt; boolean(), params =&gt; [], limit_reached =&gt; boolean(), cred_count =&gt; integer(), authorized =&gt; boolean(), authz_tooltip =&gt; binary()}</tt></p>


<h3 class="typedecl"><a name="type-parameter">parameter()</a></h3>
<p><tt>parameter() = #{key =&gt; binary(), name =&gt; binary(), description =&gt; binary(), type =&gt; atom(), mandatory =&gt; boolean()}</tt></p>


<h3 class="typedecl"><a name="type-parameter_set">parameter_set()</a></h3>
<p><tt>parameter_set() = [<a href="#type-parameter">parameter()</a>]</tt></p>


<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#add-1">add/1</a></td><td>add a service to the ets database, used during initialization.</td></tr>
<tr><td valign="top"><a href="#add_queue-2">add_queue/2*</a></td><td>add a queue to jobs.</td></tr>
<tr><td valign="top"><a href="#allows_same_state-1">allows_same_state/1</a></td><td>wether the plugin may return the same state twice.</td></tr>
<tr><td valign="top"><a href="#are_params_valid-2">are_params_valid/2</a></td><td>check if the passed request parameters are valid for the service.</td></tr>
<tr><td valign="top"><a href="#convert_to_type-2">convert_to_type/2*</a></td><td>convert the valut to the given type.</td></tr>
<tr><td valign="top"><a href="#exists-1">exists/1</a></td><td>return if a service with the given id exists.</td></tr>
<tr><td valign="top"><a href="#filter_list_for_user-2">filter_list_for_user/2*</a></td><td>filter the list of services for a user, to hide them.</td></tr>
<tr><td valign="top"><a href="#fulfills_paramset-2">fulfills_paramset/2*</a></td><td>check if the list of keys are fullfilling the given parameter set.</td></tr>
<tr><td valign="top"><a href="#gen_queue_name-1">gen_queue_name/1*</a></td><td>generate the name of a queue: the atom 'watts_service-ID'.</td></tr>
<tr><td valign="top"><a href="#get_and_validate_parameter-1">get_and_validate_parameter/1*</a></td><td>get and validate the parameter from the plugin.</td></tr>
<tr><td valign="top"><a href="#get_credential_limit-1">get_credential_limit/1</a></td><td>get the credential limit for a service.</td></tr>
<tr><td valign="top"><a href="#get_info-1">get_info/1</a></td><td>get the info for a sepcific service id.</td></tr>
<tr><td valign="top"><a href="#get_list-0">get_list/0</a></td><td>get a list of all services currently configured.</td></tr>
<tr><td valign="top"><a href="#get_list-1">get_list/1</a></td><td>get the list of all services for a user.</td></tr>
<tr><td valign="top"><a href="#get_queue-1">get_queue/1</a></td><td>get the queue name (an atom) for a service id.</td></tr>
<tr><td valign="top"><a href="#is_allowed-2">is_allowed/2</a></td><td>checks if a user is allowed to use the given service.</td></tr>
<tr><td valign="top"><a href="#is_allowed-3">is_allowed/3*</a></td><td>checking the service authorization rules
  see watts_service_authz.</td></tr>
<tr><td valign="top"><a href="#is_enabled-1">is_enabled/1</a></td><td>return if a service, given by the id, is enabled.</td></tr>
<tr><td valign="top"><a href="#is_valid_key-1">is_valid_key/1*</a></td><td>return if a key is valid.</td></tr>
<tr><td valign="top"><a href="#is_valid_key_char-1">is_valid_key_char/1*</a></td><td>ceck if the character is valid within a key.</td></tr>
<tr><td valign="top"><a href="#list_skipped_parameter_and_delete_config-1">list_skipped_parameter_and_delete_config/1*</a></td><td>list the skipped parameter from the config and delete the raw config.</td></tr>
<tr><td valign="top"><a href="#maybe_warn_default-4">maybe_warn_default/4*</a></td><td>print a warning if using the default value from the plugin.</td></tr>
<tr><td valign="top"><a href="#start_runner_queue_if_needed-1">start_runner_queue_if_needed/1*</a></td><td>start the runnuner queue if needed.</td></tr>
<tr><td valign="top"><a href="#to_atom-1">to_atom/1*</a></td><td>convert the binary to an existing atom or unknown.</td></tr>
<tr><td valign="top"><a href="#to_conf_type-1">to_conf_type/1*</a></td><td>convert the type to a configuration type.</td></tr>
<tr><td valign="top"><a href="#to_request_type-1">to_request_type/1*</a></td><td>convert the type to a request type.</td></tr>
<tr><td valign="top"><a href="#to_valid_type-2">to_valid_type/2*</a></td><td>try to convert the type to an atom and find it in the given list.</td></tr>
<tr><td valign="top"><a href="#update_conf_parameter-5">update_conf_parameter/5*</a></td><td>check the conversion results and update the config if all okay.</td></tr>
<tr><td valign="top"><a href="#update_limits_for_user-2">update_limits_for_user/2*</a></td><td>update the list for the user with limits and permissions.</td></tr>
<tr><td valign="top"><a href="#update_params-1">update_params/1</a></td><td>update the parameter of a service by running the plugin.</td></tr>
<tr><td valign="top"><a href="#update_service-2">update_service/2*</a></td><td>update the config of the service in the ets.</td></tr>
<tr><td valign="top"><a href="#validate_call_parameter-9">validate_call_parameter/9*</a></td><td>validate one parameter for a call (part of a parameter set).</td></tr>
<tr><td valign="top"><a href="#validate_call_parameter_set-2">validate_call_parameter_set/2*</a></td><td>validate a single parameter set.</td></tr>
<tr><td valign="top"><a href="#validate_call_parameter_set-5">validate_call_parameter_set/5*</a></td><td>validate a call parameter set and keep track of the result.</td></tr>
<tr><td valign="top"><a href="#validate_call_parameter_sets-2">validate_call_parameter_sets/2*</a></td><td>validate the call parameter sets.</td></tr>
<tr><td valign="top"><a href="#validate_call_parameter_sets-3">validate_call_parameter_sets/3*</a></td><td>validate the call parameter sets and keep track of the result
  Itterate through each parameter set, validating it.</td></tr>
<tr><td valign="top"><a href="#validate_conf_parameter-2">validate_conf_parameter/2*</a></td><td>validate configuration parameter.</td></tr>
<tr><td valign="top"><a href="#validate_conf_parameter-3">validate_conf_parameter/3*</a></td><td>validate the configuration parameter and keep track of the result.</td></tr>
<tr><td valign="top"><a href="#validate_params_and_update_db-3">validate_params_and_update_db/3*</a></td><td>validate the parameter returned from the plugin and maybe update the ets.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="add-1">add/1</a></h3>
<div class="spec">
<p><tt>add(ServiceInfo::<a href="#type-info">info()</a>) -&gt; {ok, binary()} | {error, invalid_config}</tt><br></p>
</div><p>add a service to the ets database, used during initialization</p>

<h3 class="function"><a name="add_queue-2">add_queue/2 *</a></h3>
<div class="spec">
<p><tt>add_queue(Id::binary(), NumRunner::integer()) -&gt; ok</tt><br></p>
</div><p>add a queue to jobs</p>

<h3 class="function"><a name="allows_same_state-1">allows_same_state/1</a></h3>
<div class="spec">
<p><tt>allows_same_state(ServiceId::binary()) -&gt; boolean()</tt><br></p>
</div><p>wether the plugin may return the same state twice</p>

<h3 class="function"><a name="are_params_valid-2">are_params_valid/2</a></h3>
<div class="spec">
<p><tt>are_params_valid(Params::#{}, ServiceId::<a href="#type-info">info()</a> | <a href="#type-limited_info">limited_info()</a> | binary()) -&gt; boolean()</tt><br></p>
</div><p>check if the passed request parameters are valid for the service</p>

<h3 class="function"><a name="convert_to_type-2">convert_to_type/2 *</a></h3>
<div class="spec">
<p><tt>convert_to_type(Value::binary(), X2::atom()) -&gt; {ok, binary() | atom()} | {error, bad_value}</tt><br></p>
</div><p>convert the valut to the given type.</p>

<h3 class="function"><a name="exists-1">exists/1</a></h3>
<div class="spec">
<p><tt>exists(ServiceId::binary()) -&gt; boolean()</tt><br></p>
</div><p>return if a service with the given id exists</p>

<h3 class="function"><a name="filter_list_for_user-2">filter_list_for_user/2 *</a></h3>
<div class="spec">
<p><tt>filter_list_for_user(UserInfo::<a href="watts_userinfo.html#type-info">watts_userinfo:info()</a>, ServiceList::[<a href="#type-info">info()</a>]) -&gt; {ok, [<a href="#type-info">info()</a>]}</tt><br></p>
</div><p>filter the list of services for a user, to hide them.</p>

<h3 class="function"><a name="fulfills_paramset-2">fulfills_paramset/2 *</a></h3>
<div class="spec">
<p><tt>fulfills_paramset(Params::[binary()], List::<a href="#type-parameter_set">parameter_set()</a>) -&gt; boolean()</tt><br></p>
</div><p>check if the list of keys are fullfilling the given parameter set</p>

<h3 class="function"><a name="gen_queue_name-1">gen_queue_name/1 *</a></h3>
<div class="spec">
<p><tt>gen_queue_name(Id::binary()) -&gt; atom()</tt><br></p>
</div><p>generate the name of a queue: the atom 'watts_service-ID'.
  Where ID is the id of the service.</p>

<h3 class="function"><a name="get_and_validate_parameter-1">get_and_validate_parameter/1 *</a></h3>
<div class="spec">
<p><tt>get_and_validate_parameter(X1::{ok, {binary(), <a href="#type-info">info()</a>}} | any()) -&gt; ok | {error, not_found}</tt><br></p>
</div><p>get and validate the parameter from the plugin.</p>

<h3 class="function"><a name="get_credential_limit-1">get_credential_limit/1</a></h3>
<div class="spec">
<p><tt>get_credential_limit(ServiceId::binary()) -&gt; {ok, integer() | infinite}</tt><br></p>
</div><p>get the credential limit for a service</p>

<h3 class="function"><a name="get_info-1">get_info/1</a></h3>
<div class="spec">
<p><tt>get_info(ServiceId::binary()) -&gt; {ok, <a href="#type-info">info()</a>} | {error, Reason::atom()}</tt><br></p>
</div><p>get the info for a sepcific service id</p>

<h3 class="function"><a name="get_list-0">get_list/0</a></h3>
<div class="spec">
<p><tt>get_list() -&gt; {ok, [<a href="#type-info">info()</a>]}</tt><br></p>
</div><p>get a list of all services currently configured.</p>

<h3 class="function"><a name="get_list-1">get_list/1</a></h3>
<div class="spec">
<p><tt>get_list(UserInfo::<a href="watts_userinfo.html#type-userinfo">watts_userinfo:userinfo()</a>) -&gt; {ok, [<a href="#type-limited_info">limited_info()</a>]}</tt><br></p>
</div><p>get the list of all services for a user</p>

<h3 class="function"><a name="get_queue-1">get_queue/1</a></h3>
<div class="spec">
<p><tt>get_queue(ServiceId::binary()) -&gt; {ok, atom()}</tt><br></p>
</div><p>get the queue name (an atom) for a service id</p>

<h3 class="function"><a name="is_allowed-2">is_allowed/2</a></h3>
<div class="spec">
<p><tt>is_allowed(UserInfo::<a href="watts_userinfo.html#type-userinfo">watts_userinfo:userinfo()</a>, ServiceId::binary()) -&gt; boolean()</tt><br></p>
</div><p>checks if a user is allowed to use the given service</p>
<p><b>See also:</b> <a href="#is_allowed-3">is_allowed/3</a>.</p>

<h3 class="function"><a name="is_allowed-3">is_allowed/3 *</a></h3>
<div class="spec">
<p><tt>is_allowed(ServiceId::binary(), UserInfo::<a href="watts_userinfo.html#type-userinfo">watts_userinfo:userinfo()</a>, AuthzConf::<a href="watts_service_authz.html#type-config">watts_service_authz:config()</a>) -&gt; boolean()</tt><br></p>
</div><p>checking the service authorization rules
  see watts_service_authz</p>

<h3 class="function"><a name="is_enabled-1">is_enabled/1</a></h3>
<div class="spec">
<p><tt>is_enabled(ServiceId::binary()) -&gt; boolean()</tt><br></p>
</div><p>return if a service, given by the id, is enabled</p>

<h3 class="function"><a name="is_valid_key-1">is_valid_key/1 *</a></h3>
<div class="spec">
<p><tt>is_valid_key(Key::binary()) -&gt; boolean()</tt><br></p>
</div><p>return if a key is valid.</p>

<h3 class="function"><a name="is_valid_key_char-1">is_valid_key_char/1 *</a></h3>
<div class="spec">
<p><tt>is_valid_key_char(X1::integer()) -&gt; boolean()</tt><br></p>
</div><p>ceck if the character is valid within a key</p>

<h3 class="function"><a name="list_skipped_parameter_and_delete_config-1">list_skipped_parameter_and_delete_config/1 *</a></h3>
<div class="spec">
<p><tt>list_skipped_parameter_and_delete_config(Info::<a href="#type-info">info()</a>) -&gt; <a href="#type-info">info()</a></tt><br></p>
</div><p>list the skipped parameter from the config and delete the raw config</p>

<h3 class="function"><a name="maybe_warn_default-4">maybe_warn_default/4 *</a></h3>
<div class="spec">
<p><tt>maybe_warn_default(X1::boolean(), Id::binary(), Name::binary(), Default::any()) -&gt; ok</tt><br></p>
</div><p>print a warning if using the default value from the plugin</p>

<h3 class="function"><a name="start_runner_queue_if_needed-1">start_runner_queue_if_needed/1 *</a></h3>
<div class="spec">
<p><tt>start_runner_queue_if_needed(X1::<a href="#type-info">info()</a>) -&gt; {ok, atom()}</tt><br></p>
</div><p>start the runnuner queue if needed.</p>

<h3 class="function"><a name="to_atom-1">to_atom/1 *</a></h3>
<div class="spec">
<p><tt>to_atom(Type::binary()) -&gt; atom()</tt><br></p>
</div><p>convert the binary to an existing atom or unknown.</p>

<h3 class="function"><a name="to_conf_type-1">to_conf_type/1 *</a></h3>
<div class="spec">
<p><tt>to_conf_type(Type::binary()) -&gt; atom()</tt><br></p>
</div><p>convert the type to a configuration type.</p>

<h3 class="function"><a name="to_request_type-1">to_request_type/1 *</a></h3>
<div class="spec">
<p><tt>to_request_type(Type::binary()) -&gt; atom()</tt><br></p>
</div><p>convert the type to a request type.</p>

<h3 class="function"><a name="to_valid_type-2">to_valid_type/2 *</a></h3>
<div class="spec">
<p><tt>to_valid_type(Type::binary(), ValidTypes::[atom()]) -&gt; atom()</tt><br></p>
</div><p>try to convert the type to an atom and find it in the given list.</p>

<h3 class="function"><a name="update_conf_parameter-5">update_conf_parameter/5 *</a></h3>
<div class="spec">
<p><tt>update_conf_parameter(Name::binary(), Valid::boolean(), Default::{ok, any()} | {error, any()}, Type::atom(), Info::<a href="#type-info">info()</a>) -&gt; {boolean(), <a href="#type-info">info()</a>}</tt><br></p>
</div><p>check the conversion results and update the config if all okay.</p>

<h3 class="function"><a name="update_limits_for_user-2">update_limits_for_user/2 *</a></h3>
<div class="spec">
<p><tt>update_limits_for_user(UserInfo::<a href="watts_userinfo.html#type-info">watts_userinfo:info()</a>, ServiceList::[<a href="#type-info">info()</a>]) -&gt; {ok, [<a href="#type-limited_info">limited_info()</a>]}</tt><br></p>
</div><p>update the list for the user with limits and permissions</p>

<h3 class="function"><a name="update_params-1">update_params/1</a></h3>
<div class="spec">
<p><tt>update_params(Id::binary()) -&gt; ok | {error, not_found}</tt><br></p>
</div><p>update the parameter of a service by running the plugin</p>

<h3 class="function"><a name="update_service-2">update_service/2 *</a></h3>
<div class="spec">
<p><tt>update_service(Id::binary(), NewInfo::<a href="#type-info">info()</a>) -&gt; ok | {error, Reason::atom()}</tt><br></p>
</div><p>update the config of the service in the ets.</p>

<h3 class="function"><a name="validate_call_parameter-9">validate_call_parameter/9 *</a></h3>
<div class="spec">
<p><tt>validate_call_parameter(Key::binary(), X2::boolean(), X3::boolean(), Name::binary(), Desc::binary(), Type::atom(), Param::#{}, Id::binary(), ParamSet::<a href="#type-parameter_set">parameter_set()</a>) -&gt; {boolean(), <a href="#type-parameter_set">parameter_set()</a>}</tt><br></p>
</div><p>validate one parameter for a call (part of a parameter set)</p>

<h3 class="function"><a name="validate_call_parameter_set-2">validate_call_parameter_set/2 *</a></h3>
<div class="spec">
<p><tt>validate_call_parameter_set(Set::<a href="#type-parameter_set">parameter_set()</a>, Info::<a href="#type-info">info()</a>) -&gt; {boolean(), <a href="#type-info">info()</a>}</tt><br></p>
</div><p>validate a single parameter set.
  a singe set is a list of maps, each containing the specificaiton of
  one parameter</p>

<h3 class="function"><a name="validate_call_parameter_set-5">validate_call_parameter_set/5 *</a></h3>
<div class="spec">
<p><tt>validate_call_parameter_set(T::<a href="#type-parameter_set">parameter_set()</a>, Info::<a href="#type-info">info()</a>, ParamSet::<a href="#type-parameter_set">parameter_set()</a>, Keys::[binary()], Result::boolean()) -&gt; {boolean(), <a href="#type-info">info()</a>}</tt><br></p>
</div><p>validate a call parameter set and keep track of the result.
  also update at the end the params list within the info with each new set.</p>

<h3 class="function"><a name="validate_call_parameter_sets-2">validate_call_parameter_sets/2 *</a></h3>
<div class="spec">
<p><tt>validate_call_parameter_sets(Params::[<a href="#type-parameter_set">parameter_set()</a>], Info::<a href="#type-info">info()</a>) -&gt; {boolean(), <a href="#type-info">info()</a>}</tt><br></p>
</div><p>validate the call parameter sets</p>

<h3 class="function"><a name="validate_call_parameter_sets-3">validate_call_parameter_sets/3 *</a></h3>
<div class="spec">
<p><tt>validate_call_parameter_sets(T::[<a href="#type-parameter_set">parameter_set()</a>], Info::<a href="#type-info">info()</a>, Result::boolean()) -&gt; {boolean(), <a href="#type-info">info()</a>}</tt><br></p>
</div><p>validate the call parameter sets and keep track of the result
  Itterate through each parameter set, validating it.</p>

<h3 class="function"><a name="validate_conf_parameter-2">validate_conf_parameter/2 *</a></h3>
<div class="spec">
<p><tt>validate_conf_parameter(Params::<a href="#type-conf_parameters">conf_parameters()</a>, Info::<a href="#type-info">info()</a>) -&gt; {boolean(), <a href="#type-info">info()</a>}</tt><br></p>
</div><p>validate configuration parameter</p>

<h3 class="function"><a name="validate_conf_parameter-3">validate_conf_parameter/3 *</a></h3>
<div class="spec">
<p><tt>validate_conf_parameter(T::<a href="#type-conf_parameters">conf_parameters()</a>, Info::<a href="#type-info">info()</a>, Result::boolean()) -&gt; {boolean(), <a href="#type-info">info()</a>}</tt><br></p>
</div><p>validate the configuration parameter and keep track of the result.</p>

<h3 class="function"><a name="validate_params_and_update_db-3">validate_params_and_update_db/3 *</a></h3>
<div class="spec">
<p><tt>validate_params_and_update_db(Id::binary(), Info::<a href="#type-info">info()</a>, X3::{ok, #{}} | any()) -&gt; ok | {error, not_found}</tt><br></p>
</div><p>validate the parameter returned from the plugin and maybe update the ets</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
