<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module watts_service_authz</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module watts_service_authz</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>This module handles the authorization of users, defined by their  
sessions, to request credentials at specific services.


<h2><a name="description">Description</a></h2><p>This module handles the authorization of users, defined by their  
sessions, to request credentials at specific services. So it allows  
users the trigger the run of a plugin or not.</p>
 
  Each service has two configuration options:
  <ul>
  <li> the list of allowed users </li>
  <li> the list of forbidden users </li>
  </ul><p>  
Each entry is not a list of users but a rule to identify certain users by  
OpenID Connect information.</p>
 
  A user is allowed if at least one rule of the allow evaluates to true and
  none of the forbidden rules evaluate to true. So by default all users are
  forbidden.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-config">config()</a></h3>
<p><tt>config() = #{allow =&gt; <a href="#type-rules">rules()</a>, forbid =&gt; <a href="#type-rules">rules()</a>, tooltip =&gt; binary(), hide =&gt; boolean()}</tt></p>


<h3 class="typedecl"><a name="type-operation">operation()</a></h3>
<p><tt>operation() = contains | is_member_of | equals | regexp | any</tt></p>


<h3 class="typedecl"><a name="type-rule">rule()</a></h3>
<p><tt>rule() = {ProviderId::binary(), Key::binary(), Operation::<a href="#type-operation">operation()</a>, ConfigValue::<a href="#type-value">value()</a>}</tt></p>


<h3 class="typedecl"><a name="type-rules">rules()</a></h3>
<p><tt>rules() = [<a href="#type-rule">rule()</a>]</tt></p>


<h3 class="typedecl"><a name="type-value">value()</a></h3>
<p><tt>value() = binary() | [binary()] | <a href="re.html#type-mp">re:mp()</a> | boolean()</tt></p>


<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#add_failed-6">add_failed/6*</a></td><td>error message and failing the rules.</td></tr>
<tr><td valign="top"><a href="#any_rule_applies-3">any_rule_applies/3*</a></td><td>apply a list of rules on a user.</td></tr>
<tr><td valign="top"><a href="#apply_rule-3">apply_rule/3*</a></td><td>Get UserValue and run the operation, Default returned on error.</td></tr>
<tr><td valign="top"><a href="#does_provider_exist-2">does_provider_exist/2*</a></td><td>checks if a provider exists and if the provider is 'any'.</td></tr>
<tr><td valign="top"><a href="#get_provider_id-1">get_provider_id/1*</a></td><td>return the primary provider whith which the user logged in.</td></tr>
<tr><td valign="top"><a href="#get_rsp_provider_list-0">get_rsp_provider_list/0*</a></td><td>get the list of RPS provider.</td></tr>
<tr><td valign="top"><a href="#is_authorized-3">is_authorized/3</a></td><td>checks and returns if a user is allowed to use a service.</td></tr>
<tr><td valign="top"><a href="#limit_rules_to_provider-3">limit_rules_to_provider/3*</a></td><td>limit the rules to those that apply to the provider given.</td></tr>
<tr><td valign="top"><a href="#maybe_add_to_result-5">maybe_add_to_result/5*</a></td><td>only add a rule if a provider for the given role exists.</td></tr>
<tr><td valign="top"><a href="#perform_operation-3">perform_operation/3*</a></td><td>perform the given operation.</td></tr>
<tr><td valign="top"><a href="#return_provider_id_if_found-1">return_provider_id_if_found/1*</a></td><td>return the provider if passed a valid pid.</td></tr>
<tr><td valign="top"><a href="#return_rsp_if_enabled_and_exists-3">return_rsp_if_enabled_and_exists/3*</a></td><td>return the rsp id, if RSP are enabled and it does exist.</td></tr>
<tr><td valign="top"><a href="#validate-1">validate/1*</a></td><td>validate a rule list.</td></tr>
<tr><td valign="top"><a href="#validate-3">validate/3*</a></td><td>validate a list of rules ensuring all provider exist.</td></tr>
<tr><td valign="top"><a href="#validate_config-2">validate_config/2</a></td><td>validate the authz config of a service.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="add_failed-6">add_failed/6 *</a></h3>
<div class="spec">
<p><tt>add_failed(Reason::string(), Key::any(), Op::any(), Val::any(), Id::any(), X6::{boolean(), <a href="#type-rules">rules()</a>}) -&gt; {false, <a href="#type-rules">rules()</a>}</tt><br></p>
</div><p>error message and failing the rules.</p>

<h3 class="function"><a name="any_rule_applies-3">any_rule_applies/3 *</a></h3>
<div class="spec">
<p><tt>any_rule_applies(UserInfo::<a href="watts_userinfo.html#type-userinfo">watts_userinfo:userinfo()</a>, Rules::<a href="#type-rules">rules()</a>, Default::boolean()) -&gt; boolean()</tt><br></p>
</div><p>apply a list of rules on a user.
  this will either evaluate to true or false and so either
  allow or forbid the user.
  The rules are evaluated in an 'or' expression. So if
  at least one rule evaluates to true the whole rule-list
  is true, false otherwise.</p>

<h3 class="function"><a name="apply_rule-3">apply_rule/3 *</a></h3>
<div class="spec">
<p><tt>apply_rule(Rule::<a href="#type-rule">rule()</a>, UserInfo::<a href="watts_userinfo.html#type-userinfo">watts_userinfo:userinfo()</a>, Default::boolean()) -&gt; boolean()</tt><br></p>
</div><p>Get UserValue and run the operation, Default returned on error.</p>

<h3 class="function"><a name="does_provider_exist-2">does_provider_exist/2 *</a></h3>
<div class="spec">
<p><tt>does_provider_exist(ProviderId::binary() | any, ProviderList::[tuple()]) -&gt; {false, undefined} | {true, any} | {true, rsp} | {true, binary()}</tt><br></p>
</div><p>checks if a provider exists and if the provider is 'any'</p>

<h3 class="function"><a name="get_provider_id-1">get_provider_id/1 *</a></h3>
<div class="spec">
<p><tt>get_provider_id(ProviderName::binary()) -&gt; {ok, binary()} | {error, Reason::atom()}</tt><br></p>
</div><p>return the primary provider whith which the user logged in</p>

<h3 class="function"><a name="get_rsp_provider_list-0">get_rsp_provider_list/0 *</a></h3>
<div class="spec">
<p><tt>get_rsp_provider_list() -&gt; {ok, [{binary(), rsp}]}</tt><br></p>
</div><p>get the list of RPS provider.</p>

<h3 class="function"><a name="is_authorized-3">is_authorized/3</a></h3>
<div class="spec">
<p><tt>is_authorized(ServiceId::binary(), UserInfo::<a href="watts_userinfo.html#type-userinfo">watts_userinfo:userinfo()</a>, Config::<a href="#type-config">config()</a>) -&gt; boolean()</tt><br></p>
</div><p>checks and returns if a user is allowed to use a service.</p>

<h3 class="function"><a name="limit_rules_to_provider-3">limit_rules_to_provider/3 *</a></h3>
<div class="spec">
<p><tt>limit_rules_to_provider(Allow::<a href="#type-rules">rules()</a>, Frobid::<a href="#type-rules">rules()</a>, ProviderId::binary()) -&gt; {<a href="#type-rules">rules()</a>, <a href="#type-rules">rules()</a>}</tt><br></p>
</div><p>limit the rules to those that apply to the provider given</p>

<h3 class="function"><a name="maybe_add_to_result-5">maybe_add_to_result/5 *</a></h3>
<div class="spec">
<p><tt>maybe_add_to_result(X1::{Add::boolean(), ProviderId::binary() | any | rsp}, Operation::<a href="#type-operation">operation()</a>, OidcKey::binary(), Value::<a href="#type-value">value()</a>, Result::{Result::boolean(), List::<a href="#type-rules">rules()</a>}) -&gt; {IsOkay::boolean(), Rules::<a href="#type-rules">rules()</a>}</tt><br></p>
</div><p>only add a rule if a provider for the given role exists</p>

<h3 class="function"><a name="perform_operation-3">perform_operation/3 *</a></h3>
<div class="spec">
<p><tt>perform_operation(Operation::<a href="#type-operation">operation()</a>, UserValue::<a href="#type-value">value()</a>, ConfigValue::<a href="#type-value">value()</a>) -&gt; boolean()</tt><br></p>
</div><p>perform the given operation.
  A the moment the following operations are supported:
  <ul>
  <li> any: returns the configured boolean value </li>
  <li> equals: returns if the config and userinfo value are equal </li>
  <li> is_member_of: checks if user value is part of the config list </li>
  <li> contains: checks if the config value is contained in the user value</li>
  <li> regexp: checks the user value against a regular expression </li>
  </ul></p>

<h3 class="function"><a name="return_provider_id_if_found-1">return_provider_id_if_found/1 *</a></h3>
<div class="spec">
<p><tt>return_provider_id_if_found(X1::{ok, pid} | any()) -&gt; {ok, binary()} | {error, provider_not_found}</tt><br></p>
</div><p>return the provider if passed a valid pid</p>

<h3 class="function"><a name="return_rsp_if_enabled_and_exists-3">return_rsp_if_enabled_and_exists/3 *</a></h3>
<div class="spec">
<p><tt>return_rsp_if_enabled_and_exists(RspId::binary(), X2::boolean(), X3::boolean()) -&gt; {ok, binary()} | {error, rsp_disabled}</tt><br></p>
</div><p>return the rsp id, if RSP are enabled and it does exist.</p>

<h3 class="function"><a name="validate-1">validate/1 *</a></h3>
<div class="spec">
<p><tt>validate(Rules::<a href="#type-rules">rules()</a>) -&gt; {Failed::boolean(), ValidatedRules::<a href="#type-rules">rules()</a>}</tt><br></p>
</div><p>validate a rule list</p>

<h3 class="function"><a name="validate-3">validate/3 *</a></h3>
<div class="spec">
<p><tt>validate(T::<a href="#type-rules">rules()</a>, ProviderList::list(), Result::{boolean(), <a href="#type-rules">rules()</a>}) -&gt; {Failed::boolean(), ValidatedRules::<a href="#type-rules">rules()</a>}</tt><br></p>
</div><p>validate a list of rules ensuring all provider exist.</p>

<h3 class="function"><a name="validate_config-2">validate_config/2</a></h3>
<div class="spec">
<p><tt>validate_config(ServiceId::binary(), Config::<a href="#type-config">config()</a>) -&gt; {ok, ValidatedConfig::<a href="#type-config">config()</a>}</tt><br></p>
</div><p>validate the authz config of a service.</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
