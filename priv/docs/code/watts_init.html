<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module watts_init</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module watts_init</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>The watts_init module takes care of the initialization of WaTTS.

<p><b>Behaviours:</b> <a href="gen_server.html"><tt>gen_server</tt></a>.</p>

<h2><a name="description">Description</a></h2><p>The watts_init module takes care of the initialization of WaTTS.  
It uses the application environment set by the cuttlefish.</p>
 
  <p>Cuttlefish is a config parsing and validation tool creating a set of  
parameter for the actual application to run, it is configured by schemas,  
those are stored at /config/schema.</p>
 
  <p>Once the configuration file is parsed and is valid the result is passed to  
the application environment of WaTTS.</p>
 
  <p>Once WaTTS and all it's dependencies are loaded this part starts running and  
configures the application.</p>
 
  The steps taken to configure the server include:
  <ul>
  <li> setup the database </li>
  <li> initilize the OpenID Connect provider </li>
  <li> configure the services with their plugins </li>
  <li> start the web interface </li>
  </ul>
  The most important functions are <a href="#init-1"><code>init/1</code></a> and <a href="#handle_cast-2"><code>handle_cast/2</code></a>.
<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#add_openid_provider-0">add_openid_provider/0*</a></td><td>add the configured openid provider.</td></tr>
<tr><td valign="top"><a href="#add_openid_provider-2">add_openid_provider/2*</a></td><td>take one provider from the list and add it.</td></tr>
<tr><td valign="top"><a href="#add_options-5">add_options/5*</a></td><td>dynamically generate the list of options for the webserver.</td></tr>
<tr><td valign="top"><a href="#add_rsps-0">add_rsps/0*</a></td><td>Add the configured RSPs as they are enabled in the config.</td></tr>
<tr><td valign="top"><a href="#add_services-0">add_services/0*</a></td><td>add the services to the server and log the results.</td></tr>
<tr><td valign="top"><a href="#code_change-3">code_change/3</a></td><td>just a dummy to be compliant with the behaviour, no functionality.</td></tr>
<tr><td valign="top"><a href="#create_dispatch_list-0">create_dispatch_list/0*</a></td><td>This is the list of endpoints and the corresponding action to happen,  
this could be either calling a function or serving static files.</td></tr>
<tr><td valign="top"><a href="#create_dispatch_list-2">create_dispatch_list/2*</a></td><td>handle each configuration and transform it into a dispatch entry.</td></tr>
<tr><td valign="top"><a href="#enforce_security-0">enforce_security/0*</a></td><td>enforces WaTTS to run in a secure setting.</td></tr>
<tr><td valign="top"><a href="#error_if_running_as_root-0">error_if_running_as_root/0*</a></td><td>ensure WaTTS is not running as root.</td></tr>
<tr><td valign="top"><a href="#handle_call-3">handle_call/3</a></td><td>just a dummy to be compliant with the behaviour, no functionality.</td></tr>
<tr><td valign="top"><a href="#handle_cast-2">handle_cast/2</a></td><td>this is where the magic happens.</td></tr>
<tr><td valign="top"><a href="#handle_info-2">handle_info/2</a></td><td>just a dummy to be compliant with the behaviour, no functionality.</td></tr>
<tr><td valign="top"><a href="#init-1">init/1</a></td><td>staring the initializing process.</td></tr>
<tr><td valign="top"><a href="#init_watts-0">init_watts/0*</a></td><td>start initalization of WaTTS.</td></tr>
<tr><td valign="top"><a href="#local_endpoint-0">local_endpoint/0*</a></td><td>return the local endpoint.</td></tr>
<tr><td valign="top"><a href="#maybe_add_rsps-1">maybe_add_rsps/1*</a></td><td>Add RSPs if enabled in the configuration.</td></tr>
<tr><td valign="top"><a href="#maybe_change_hostname-3">maybe_change_hostname/3*</a></td><td>change the hostname to localhost if not configured well.</td></tr>
<tr><td valign="top"><a href="#maybe_recheck_provider-3">maybe_recheck_provider/3*</a></td><td>recheck the provider for their status if still in time.</td></tr>
<tr><td valign="top"><a href="#maybe_root_halt-2">maybe_root_halt/2*</a></td><td>halt the VM if uid is 0 or user is 'root'.</td></tr>
<tr><td valign="top"><a href="#maybe_start_rsp_queue-2">maybe_start_rsp_queue/2*</a></td><td>decide if the rate limit for rsp endpoint needs to be started.</td></tr>
<tr><td valign="top"><a href="#maybe_start_web_queue-1">maybe_start_web_queue/1*</a></td><td>decide if the rate limit for api endpoint needs to be started.</td></tr>
<tr><td valign="top"><a href="#maybe_start_web_queues-0">maybe_start_web_queues/0*</a></td><td>maybe start the queues for rate limits at the api and rsp endpoint.</td></tr>
<tr><td valign="top"><a href="#read_cachain-1">read_cachain/1*</a></td><td>read the ca chain for SSL.</td></tr>
<tr><td valign="top"><a href="#read_certificate-1">read_certificate/1*</a></td><td>read the certificate for SSL.</td></tr>
<tr><td valign="top"><a href="#read_dhparam-1">read_dhparam/1*</a></td><td>read the dh params for SSL.</td></tr>
<tr><td valign="top"><a href="#read_key-1">read_key/1*</a></td><td>read the private key for SSL.</td></tr>
<tr><td valign="top"><a href="#read_ssl_files-1">read_ssl_files/1*</a></td><td>try to read the SSL files and return if successful.</td></tr>
<tr><td valign="top"><a href="#remove_newline-1">remove_newline/1*</a></td><td>helperfunction to remove newlines from data.</td></tr>
<tr><td valign="top"><a href="#start_database-0">start_database/0*</a></td><td>start the databases needed to run WaTTS.</td></tr>
<tr><td valign="top"><a href="#start_if_not_started_before-0">start_if_not_started_before/0*</a></td><td>start the configuration of WaTTS if it has not been started before.</td></tr>
<tr><td valign="top"><a href="#start_if_undefined-1">start_if_undefined/1*</a></td><td>only start if the special configuration <code>watts_init_started</code> is not set.</td></tr>
<tr><td valign="top"><a href="#start_link-0">start_link/0</a></td><td>starting the gen_server process.</td></tr>
<tr><td valign="top"><a href="#start_web_interface-0">start_web_interface/0*</a></td><td>start the web interface of WaTTS.</td></tr>
<tr><td valign="top"><a href="#stop-0">stop/0*</a></td><td>gracefully stop the configuration process when done.</td></tr>
<tr><td valign="top"><a href="#stop-1">stop/1</a></td><td>function to stop the process.</td></tr>
<tr><td valign="top"><a href="#terminate-2">terminate/2</a></td><td>just a dummy to be compliant with the behaviour, no functionality.</td></tr>
<tr><td valign="top"><a href="#update_jwt_keys-0">update_jwt_keys/0*</a></td><td>generate new signing keys for jwt.</td></tr>
<tr><td valign="top"><a href="#wait_and_log_provider_results-0">wait_and_log_provider_results/0*</a></td><td>waits for the configured provides to either fail or be ready.</td></tr>
<tr><td valign="top"><a href="#wait_and_log_provider_results-3">wait_and_log_provider_results/3*</a></td><td>iterate through the list of oidc provider and check their status.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="add_openid_provider-0">add_openid_provider/0 *</a></h3>
<div class="spec">
<p><tt>add_openid_provider() -&gt; ok</tt><br></p>
</div><p>add the configured openid provider.
  this function iterates throught the configured providers and
  adds each of them. Then waits for the results so the provider can
  read the needed configs from the Internet in parallel.</p>
<p><b>See also:</b> <a href="#add_openid_provider-2">add_openid_provider/2</a>, <a href="#wait_and_log_provider_results-0">wait_and_log_provider_results/0</a>.</p>

<h3 class="function"><a name="add_openid_provider-2">add_openid_provider/2 *</a></h3>
<div class="spec">
<p><tt>add_openid_provider(Configs::[#{}], LocalEndpoint::binary()) -&gt; ok</tt><br></p>
</div><p>take one provider from the list and add it.
  This uses the oidcc library to handle the OpenID Connect provider.</p>

<h3 class="function"><a name="add_options-5">add_options/5 *</a></h3>
<div class="spec">
<p><tt>add_options(Options::[tuple()], CaChainSetting::tuple() | ok, DhParamSetting::tuple() | ok, IsOnion::boolean() | ok, IPv6Setting::tuple() | ok) -&gt; [tuple()]</tt><br></p>
</div><p>dynamically generate the list of options for the webserver.</p>

<h3 class="function"><a name="add_rsps-0">add_rsps/0 *</a></h3>
<div class="spec">
<p><tt>add_rsps() -&gt; ok</tt><br></p>
</div><p>Add the configured RSPs as they are enabled in the config.
  The function iterates through the configuration and updates them.
  No keys are fetched yet, only the configuration is updated.</p>
<p><b>See also:</b> <a href="watts_rsp.html">watts_rsp</a>, <a href="watts_rsp.html#new-1">watts_rsp:new/1</a>.</p>

<h3 class="function"><a name="add_services-0">add_services/0 *</a></h3>
<div class="spec">
<p><tt>add_services() -&gt; ok</tt><br></p>
</div><p>add the services to the server and log the results.</p>
<p><b>See also:</b> <a href="watts_service.html#add-1">watts_service:add/1</a>, <a href="watts_service.html#update_params-1">watts_service:update_params/1</a>.</p>

<h3 class="function"><a name="code_change-3">code_change/3</a></h3>
<div class="spec">
<p><tt>code_change(OldVsn::any(), State::tuple(), Extra::any()) -&gt; {ok, tuple()}</tt><br></p>
</div><p>just a dummy to be compliant with the behaviour, no functionality.</p>

<h3 class="function"><a name="create_dispatch_list-0">create_dispatch_list/0 *</a></h3>
<div class="spec">
<p><tt>create_dispatch_list() -&gt; [tuple()]</tt><br></p>
</div><p><p>This is the list of endpoints and the corresponding action to happen,  
this could be either calling a function or serving static files.</p>
 
  The function creates a basic dispatch list for the javascript to be served,
  the OpenID connect handling (login) and the api.
  Then calls the create_dispatch_list/2 function to configure the dynamic part.</p>
<p><b>See also:</b> <a href="#create_dispatch_list-2">create_dispatch_list/2</a>.</p>

<h3 class="function"><a name="create_dispatch_list-2">create_dispatch_list/2 *</a></h3>
<div class="spec">
<p><tt>create_dispatch_list(Config::[tuple()], DispatchList::[tuple()]) -&gt; [tuple()]</tt><br></p>
</div><p>handle each configuration and transform it into a dispatch entry.
  The handled settings include
  <ul>
  <li> user documentation </li>
  <li> code documentation </li>
  <li> rps endpoint </li>
  <li> privacy statement </li>
  </ul></p>

<h3 class="function"><a name="enforce_security-0">enforce_security/0 *</a></h3>
<div class="spec">
<p><tt>enforce_security() -&gt; ok</tt><br></p>
</div><p>enforces WaTTS to run in a secure setting.
  This includes running as non root user and having SSL configured.
  If SSL is not configured it will be forced to localhost.</p>
<p><b>See also:</b> <a href="#error_if_running_as_root-0">error_if_running_as_root/0</a>, <a href="#maybe_change_hostname-3">maybe_change_hostname/3</a>.</p>

<h3 class="function"><a name="error_if_running_as_root-0">error_if_running_as_root/0 *</a></h3>
<div class="spec">
<p><tt>error_if_running_as_root() -&gt; ok</tt><br></p>
</div><p>ensure WaTTS is not running as root.
  if it is running as root the VM gets stopped.</p>
<p><b>See also:</b> <a href="#maybe_root_halt-2">maybe_root_halt/2</a>.</p>

<h3 class="function"><a name="handle_call-3">handle_call/3</a></h3>
<div class="spec">
<p><tt>handle_call(Request::any(), From::any(), State::tuple()) -&gt; {reply, ignored, tuple()}</tt><br></p>
</div><p>just a dummy to be compliant with the behaviour, no functionality.</p>

<h3 class="function"><a name="handle_cast-2">handle_cast/2</a></h3>
<div class="spec">
<p><tt>handle_cast(Msg::any(), State::tuple()) -&gt; {noreply, tuple()} | {stop, normal, tuple()}</tt><br></p>
</div><p><p>this is where the magic happens.  
The process handles one step at a time and after each step it will  
send a cast to itself to trigger the next step.</p>
 
  The folowing steps are processed (in order of excution):
  <ul>
  <li> ensure the init process has not been started before </li>
  <li> set the version and ensure not running as root <em>init_watts</em> </li>
  <li> starting the database <em>start_database</em> </li>
  <li> adding the OpenID Connect provider <em>add_openid_provider</em> </li>
  <li> maybe adding RSPs, if configured <em>maybe_add_rsps</em> </li>
  <li> add the configured services <em>add_services</em> </li>
  <li> start the web interface <em>start_web_interface</em></li>
  </ul></p>
<p><b>See also:</b> <a href="#add_openid_provider-0">add_openid_provider/0</a>, <a href="#add_services-0">add_services/0</a>, <a href="#init_watts-0">init_watts/0</a>, <a href="#maybe_add_rsps-1">maybe_add_rsps/1</a>, <a href="#start_database-0">start_database/0</a>, <a href="#start_if_not_starte_before-0">start_if_not_starte_before/0</a>, <a href="#start_web_interface-0">start_web_interface/0</a>.</p>

<h3 class="function"><a name="handle_info-2">handle_info/2</a></h3>
<div class="spec">
<p><tt>handle_info(Info::any(), State::tuple()) -&gt; {noreply, tuple()}</tt><br></p>
</div><p>just a dummy to be compliant with the behaviour, no functionality.</p>

<h3 class="function"><a name="init-1">init/1</a></h3>
<div class="spec">
<p><tt>init(X1::no_parameter) -&gt; {ok, tuple()}</tt><br></p>
</div><p>staring the initializing process.
  The function just sends a cast to itself which in turn will be
  handled by handle_cast.</p>
<p><b>See also:</b> <a href="#handle_cast-2">handle_cast/2</a>.</p>

<h3 class="function"><a name="init_watts-0">init_watts/0 *</a></h3>
<div class="spec">
<p><tt>init_watts() -&gt; ok</tt><br></p>
</div><p>start initalization of WaTTS.
  This copies the version from keys to environment and enforces security</p>
<p><b>See also:</b> <a href="#enforce_security-0">enforce_security/0</a>.</p>

<h3 class="function"><a name="local_endpoint-0">local_endpoint/0 *</a></h3>
<div class="spec">
<p><tt>local_endpoint() -&gt; binary()</tt><br></p>
</div><p>return the local endpoint</p>

<h3 class="function"><a name="maybe_add_rsps-1">maybe_add_rsps/1 *</a></h3>
<div class="spec">
<p><tt>maybe_add_rsps(Enabled::boolean()) -&gt; ok</tt><br></p>
</div><p>Add RSPs if enabled in the configuration.
  Relaying Service Provider are only added if configured, else the
  configured RSPs are not added to the running WaTTS instance.</p>
<p><b>See also:</b> <a href="#add_rsps-0">add_rsps/0</a>.</p>

<h3 class="function"><a name="maybe_change_hostname-3">maybe_change_hostname/3 *</a></h3>
<div class="spec">
<p><tt>maybe_change_hostname(HasSSL::boolean(), IsOnion::boolean(), Hostname::list()) -&gt; NewHostname::list()</tt><br></p>
</div><p>change the hostname to localhost if not configured well.
  It will change to localhost if neither configured to run as a
  tor hidden service, nor having SSL configured.</p>

<h3 class="function"><a name="maybe_recheck_provider-3">maybe_recheck_provider/3 *</a></h3>
<div class="spec">
<p><tt>maybe_recheck_provider(InTime::boolean(), ProviderPending::[{Id::binary(), Pid::pid()}], MaxTime::integer()) -&gt; ok</tt><br></p>
</div><p>recheck the provider for their status if still in time.</p>

<h3 class="function"><a name="maybe_root_halt-2">maybe_root_halt/2 *</a></h3>
<div class="spec">
<p><tt>maybe_root_halt(User::list(), Uid::number()) -&gt; ok</tt><br></p>
</div><p>halt the VM if uid is 0 or user is 'root'.</p>

<h3 class="function"><a name="maybe_start_rsp_queue-2">maybe_start_rsp_queue/2 *</a></h3>
<div class="spec">
<p><tt>maybe_start_rsp_queue(X1::boolean(), Number::any()) -&gt; ok</tt><br></p>
</div><p>decide if the rate limit for rsp endpoint needs to be started</p>

<h3 class="function"><a name="maybe_start_web_queue-1">maybe_start_web_queue/1 *</a></h3>
<div class="spec">
<p><tt>maybe_start_web_queue(Number::any()) -&gt; ok</tt><br></p>
</div><p>decide if the rate limit for api endpoint needs to be started</p>

<h3 class="function"><a name="maybe_start_web_queues-0">maybe_start_web_queues/0 *</a></h3>
<div class="spec">
<p><tt>maybe_start_web_queues() -&gt; ok</tt><br></p>
</div><p>maybe start the queues for rate limits at the api and rsp endpoint</p>

<h3 class="function"><a name="read_cachain-1">read_cachain/1 *</a></h3>
<div class="spec">
<p><tt>read_cachain(X1::any()) -&gt; Success::boolean()</tt><br></p>
</div><p>read the ca chain for SSL</p>

<h3 class="function"><a name="read_certificate-1">read_certificate/1 *</a></h3>
<div class="spec">
<p><tt>read_certificate(X1::any()) -&gt; Success::boolean()</tt><br></p>
</div><p>read the certificate for SSL</p>

<h3 class="function"><a name="read_dhparam-1">read_dhparam/1 *</a></h3>
<div class="spec">
<p><tt>read_dhparam(X1::any()) -&gt; Success::boolean()</tt><br></p>
</div><p>read the dh params for SSL</p>

<h3 class="function"><a name="read_key-1">read_key/1 *</a></h3>
<div class="spec">
<p><tt>read_key(X1::any()) -&gt; Success::boolean()</tt><br></p>
</div><p>read the private key for SSL</p>

<h3 class="function"><a name="read_ssl_files-1">read_ssl_files/1 *</a></h3>
<div class="spec">
<p><tt>read_ssl_files(ShouldBeRead::boolean()) -&gt; UseSSL::boolean()</tt><br></p>
</div><p>try to read the SSL files and return if successful.
  This function is reading
  <ul>
  <li> the certificat </li>
  <li> the private key </li>
  <li> the ca chain </li>
  <li> the dh params </li>
  </ul>
  SSL gets disable if one of them fails.</p>

<h3 class="function"><a name="remove_newline-1">remove_newline/1 *</a></h3>
<div class="spec">
<p><tt>remove_newline(List::string()) -&gt; string()</tt><br></p>
</div><p>helperfunction to remove newlines from data</p>

<h3 class="function"><a name="start_database-0">start_database/0 *</a></h3>
<div class="spec">
<p><tt>start_database() -&gt; ok</tt><br></p>
</div><p>start the databases needed to run WaTTS.
  The in ram database is started using watts_ets and the
  configured persistent database is started with watts_persistent.</p>
<p><b>See also:</b> <a href="watts_ets.html#init-0">watts_ets:init/0</a>, <a href="watts_persistent.html#init-0">watts_persistent:init/0</a>.</p>

<h3 class="function"><a name="start_if_not_started_before-0">start_if_not_started_before/0 *</a></h3>
<div class="spec">
<p><tt>start_if_not_started_before() -&gt; ok</tt><br></p>
</div><p>start the configuration of WaTTS if it has not been started before.
  If it has been started before, the configuration crashed, which means
  that something unexpected happened. As this is a critical issue WaTTS
  will be stoppped then.</p>

<h3 class="function"><a name="start_if_undefined-1">start_if_undefined/1 *</a></h3>
<div class="spec">
<p><tt>start_if_undefined(Started::undefined | any()) -&gt; ok</tt><br></p>
</div><p>only start if the special configuration <code>watts_init_started</code> is not set.</p>

<h3 class="function"><a name="start_link-0">start_link/0</a></h3>
<div class="spec">
<p><tt>start_link() -&gt; {ok, pid()}</tt><br></p>
</div><p>starting the gen_server process.</p>

<h3 class="function"><a name="start_web_interface-0">start_web_interface/0 *</a></h3>
<div class="spec">
<p><tt>start_web_interface() -&gt; ok</tt><br></p>
</div><p><p>start the web interface of WaTTS.  
This starts the main web server with the API, the static file serving of  
the java script SPA and, if configured, the documentations. The redirection  
from http to https endpoint is also started if configured.</p>
 
  To configure SSL first the files are read and if that fails SSL is disabled.</p>
<p><b>See also:</b> <a href="#add_options-5">add_options/5</a>, <a href="#create_dispatch_list-0">create_dispatch_list/0</a>.</p>

<h3 class="function"><a name="stop-0">stop/0 *</a></h3>
<div class="spec">
<p><tt>stop() -&gt; ok</tt><br></p>
</div><p>gracefully stop the configuration process when done.</p>

<h3 class="function"><a name="stop-1">stop/1</a></h3>
<div class="spec">
<p><tt>stop(Pid::pid()) -&gt; ok</tt><br></p>
</div><p>function to stop the process.</p>

<h3 class="function"><a name="terminate-2">terminate/2</a></h3>
<div class="spec">
<p><tt>terminate(Reason::any(), State::tuple()) -&gt; ok</tt><br></p>
</div><p>just a dummy to be compliant with the behaviour, no functionality.</p>

<h3 class="function"><a name="update_jwt_keys-0">update_jwt_keys/0 *</a></h3>
<div class="spec">
<p><tt>update_jwt_keys() -&gt; ok</tt><br></p>
</div><p>generate new signing keys for jwt</p>

<h3 class="function"><a name="wait_and_log_provider_results-0">wait_and_log_provider_results/0 *</a></h3>
<div class="spec">
<p><tt>wait_and_log_provider_results() -&gt; ok</tt><br></p>
</div><p>waits for the configured provides to either fail or be ready.
  The configuration max_provider_wait sets the max time to wait, the
  default is 5 seconds. Reducing this time will speedup the startup.</p>
<p><b>See also:</b> <a href="#wait_and_log_provider_results-3">wait_and_log_provider_results/3</a>.</p>

<h3 class="function"><a name="wait_and_log_provider_results-3">wait_and_log_provider_results/3 *</a></h3>
<div class="spec">
<p><tt>wait_and_log_provider_results(Provider::[{Id::binary(), Pid::pid()}], Pending::[{Id::binary(), Pid::pid()}], Timeout::integer()) -&gt; ok</tt><br></p>
</div><p>iterate through the list of oidc provider and check their status.
  A new list is set up with pending provider and maybe checked again if
  the timeout has not yet been reached.</p>
<p><b>See also:</b> <a href="#maybe_recheck_provider-3">maybe_recheck_provider/3</a>.</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
