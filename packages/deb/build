#!/bin/bash

repo_root=`pwd`

packages=$repo_root/packages/deb
structure_tar=$packages/structure.tar.gz
structure=tts
prod_tar=$repo_root/_build/prod/rel/tts/tts*.tar.gz
tts=$packages/$structure/usr/local/lib/tts
build=$repo_root/_build/packages
if [[ ! -d $build ]]; then mkdir -p $build; fi


cd $packages
if [[ -d $structure ]]; then rm -rf $structure; fi
echo extracting structure from $structure_tar
tar xaf $structure_tar
if [[ ! -d $structure ]]; then echo no structure found; exit 1; fi
echo

# prod_tar
pushd $tts
echo extracting production data from $prod_tar
tar -xaf $prod_tar
popd
echo

# determine version
version=`echo $tts/lib/tts-*`
version=${version#*-}
version=${version#v}

# create control file
version_scheme=$packages/version
control_scheme=$packages/control
control=$packages/$structure/DEBIAN/control
echo "Version: $version" > $version_scheme
cat $control_scheme $version_scheme > $control
cat $control
echo

# include the client
cp $repo_root/client/* $packages/$structure/usr/local/bin

# build deb package
dpkg-deb --build $packages/$structure $build/tts-${version}.deb


# clean up
rm -rf $structure $version_scheme
