{minimum_otp_vsn, "18.1"}.
{erl_opts, [
            {parse_transform, lager_transform}
           ]}.

{deps, [
        {node_package, {git, "https://github.com/bwegh/node_package.git", {branch, "rebar3-support"}}},
        {jobs, {git, "https://github.com/uwiger/jobs", {tag, "0.5"}}},

        {oidcc_cowboy, "1.0.0"},
        {cowboy, "1.0.4"},
        {uuid_erl, "1.5.4"},
        {econfig, "0.7.3"},
        {eper, "0.94.0"},
        {esqlite, "0.2.2"},
        {lager, "3.2.1"}
       ]
}.

{relx, [{release, {watts, "semver"},
         [watts]},
        {vm_args, "config/vm.args"},
        {dev_mode, false},
        {include_erts, true},
        {include_src, false},
        {overlay_vars, "config/vars_gen.config"},
        {generate_start_script, false},
        {overlay, [
                   {mkdir, "etc"},
                   {template, "config/vm.args","etc/vm.args"},

                   {mkdir, "share/schema"},
                   {template, "config/schema/watts.schema","share/schema/01_watts.schema"},
                   {template, "config/schema/oidc.schema","share/schema/02_oidc.schema"},
                   {template, "config/schema/service.schema","share/schema/03_service.schema"},
                   {template, "config/schema/apps.schema","share/schema/99_apps.schema"},

                   %% the erlang run time and scripts
                   {mkdir, "bin"},
                   {copy, "_build/default/lib/node_package/priv/base/erl", "erts-{{erts_vsn}}/bin/erl"},
                   {template, "_build/default/lib/node_package/priv/base/runner", "bin/watts"},
                   {template, "_build/default/lib/node_package/priv/base/nodetool", "erts-{{erts_vsn}}/bin/nodetool"},
                   {template, "_build/default/lib/node_package/priv/base/env.sh", "lib/env.sh"},

                   %% ensure the data folder (/var/lib/watts) exists, else packaging fails
                   {mkdir, "data/plugins"}
                  ]}
       ]}.


{profiles, [
            {test, [
                    {deps, [meck]},
                    {cover_enabled, true}
                   ]}
           ]}.

{elvis, [
         #{dirs => ["."],
           filter => "elvis.config",
           ruleset => elvis_config
          },
         #{dirs => ["src"],
           filter => "*.erl",
           ruleset => erl_files,
           rules => [
                     {elvis_style, invalid_dynamic_call, #{ignore => [tts_cred_worker]}},
                     {elvis_style, god_modules, #{limit => 25, ignore => [tts_session]}}
                    ]
          },
         #{dirs => ["."],
           filter => "Makefile",
           ruleset => makefiles
          },
         #{dirs => ["."],
           filter => "rebar.config",
           ruleset => rebar_config
          }
        ]}.

{project_plugins, [rebar3_cuttlefish]}.
{cuttlefish, [{schema_discovery, false}]}.
{plugins, [
           {rebar3_lint, {git, "https://github.com/bwegh/rebar3_lint.git", {ref, "a9c4166"}}}
          ]}.
